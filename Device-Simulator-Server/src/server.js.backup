const express = require('express');
const http = re        // æ—¥å¿—ä¸­é—´ä»¶
        this.app.use((req, res, next)     /**
     * è®¾ç½®WebSocketå¤„ç†
     */
    setupWebSocket() {
        // è·Ÿè¸ªè¿æ¥çš„å®¢æˆ·ç«¯
        this.io.on('connection', (socket) => {
            this.connectedClients++;
            console.log(`ğŸ“± å®¢æˆ·ç«¯è¿æ¥: ${socket.id}, æ€»è¿æ¥æ•°: ${this.connectedClients}`);
            
            socket.on('disconnect', () => {
                this.connectedClients--;
                console.log(`ğŸ“± å®¢æˆ·ç«¯æ–­å¼€: ${socket.id}, æ€»è¿æ¥æ•°: ${this.connectedClients}`);
            });
        });
        
        const wsHandler = new WebSocketHandler(this.io, this.deviceManager);
        wsHandler.initialize();
    }

    /**
     * è·å–è¿æ¥çš„å®¢æˆ·ç«¯æ•°é‡
     */
    getConnectedClientsCount() {
        return this.connectedClients;
    }

    /**
     * è·å–APIè°ƒç”¨æ¬¡æ•°
     */
    getApiCallsCount() {
        return this.apiCallsCount;
    }           console.log(`${new Date().toISOString()} - ${req.method} ${req.url}`);
            
            // ç»Ÿè®¡APIè°ƒç”¨æ¬¡æ•°
            if (req.url.startsWith('/api/')) {
                this.apiCallsCount++;
            }
            
            next();
        });('http');
const socketIo = require('socket.io');
const cors = require('cors');
const bodyParser = require('body-parser');
const path = require('path');

const DeviceManager = require('./device/DeviceManager');
const ApiRouter = require('./api/ApiRouter');
const WebSocketHandler = require('./websocket/WebSocketHandler');
const DiscoveryService = require('./discovery/DiscoveryService');

/**
 * SSLABæ™ºèƒ½ç¡¬ä»¶è®¾å¤‡æ¨¡æ‹Ÿå™¨æœåŠ¡å™¨
 * æä¾›Webç•Œé¢ç®¡ç†è®¾å¤‡å’ŒREST APIæ¥å£
 */
class DeviceSimulatorServer {
    constructor() {
        this.app = express();
        this.server = http.createServer(this.app);
        this.io = socketIo(this.server, {
            cors: {
                origin: "*",
                methods: ["GET", "POST"]
            }
        });
        
        this.port = process.env.PORT || 8080;
        this.deviceManager = new DeviceManager();
        this.discoveryService = new DiscoveryService(this.deviceManager);
        
        // ç»Ÿè®¡ä¿¡æ¯
        this.connectedClients = 0;
        this.apiCallsCount = 0;
        
        this.setupMiddleware();
        this.setupRoutes();
        this.setupWebSocket();
        this.setupDiscovery();
    }
    
    /**
     * è®¾ç½®ä¸­é—´ä»¶
     */
    setupMiddleware() {
        this.app.use(cors());
        this.app.use(bodyParser.json());
        this.app.use(bodyParser.urlencoded({ extended: true }));
        
        // é™æ€æ–‡ä»¶æœåŠ¡
        this.app.use(express.static(path.join(__dirname, '../public')));
        
        // æ—¥å¿—ä¸­é—´ä»¶
        this.app.use((req, res, next) => {
            console.log(`[${new Date().toISOString()}] ${req.method} ${req.url}`);
            next();
        });
    }
    
    /**
     * è®¾ç½®è·¯ç”±
     */
    setupRoutes() {
        // APIè·¯ç”±
        const apiRouter = new ApiRouter(this.deviceManager, this);
        this.app.use('/api', apiRouter.getRouter());
        
        // ä¸»é¡µè·¯ç”±
        this.app.get('/', (req, res) => {
            res.sendFile(path.join(__dirname, '../public/index.html'));
        });
        
        // è®¾å¤‡ç®¡ç†é¡µé¢
        this.app.get('/devices', (req, res) => {
            res.sendFile(path.join(__dirname, '../public/devices.html'));
        });
        
        // åˆ†ç»„ç®¡ç†é¡µé¢
        this.app.get('/groups', (req, res) => {
            res.sendFile(path.join(__dirname, '../public/groups.html'));
        });
        
        // ç›‘æ§é¡µé¢
        this.app.get('/monitor', (req, res) => {
            res.sendFile(path.join(__dirname, '../public/monitor.html'));
        });
        
        // ç³»ç»Ÿç®¡ç†é¡µé¢
        this.app.get('/admin', (req, res) => {
            res.sendFile(path.join(__dirname, '../public/admin.html'));
        });
        
        // å¯¼èˆªæ ç»„ä»¶è·¯ç”±
        this.app.get('/components/navbar.html', (req, res) => {
            res.sendFile(path.join(__dirname, '../public/components/navbar.html'));
        });
    }
    
    /**
     * è®¾ç½®WebSocket
     */
    setupWebSocket() {
        const wsHandler = new WebSocketHandler(this.io, this.deviceManager);
        wsHandler.initialize();
    }
    
    /**
     * è®¾ç½®è®¾å¤‡å‘ç°æœåŠ¡
     */
    setupDiscovery() {
        this.discoveryService.start();
    }
    
    /**
     * å¯åŠ¨æœåŠ¡å™¨
     */
    start() {
        this.server.listen(this.port, () => {
            console.log(`\nğŸš€ SSLABè®¾å¤‡æ¨¡æ‹Ÿå™¨æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ`);
            console.log(`ğŸ“± Webç•Œé¢: http://localhost:${this.port}`);
            console.log(`ğŸ”Œ APIæ¥å£: http://localhost:${this.port}/api`);
            console.log(`ğŸŒ WebSocket: ws://localhost:${this.port}`);
            console.log(`ğŸ“¡ mDNSå‘ç°æœåŠ¡å·²å¯åŠ¨`);
            console.log(`\nğŸ“‹ å¯ç”¨é¡µé¢:`);
            console.log(`   ä¸»é¡µ:     http://localhost:${this.port}/`);
            console.log(`   è®¾å¤‡ç®¡ç†: http://localhost:${this.port}/devices`);
            console.log(`   åˆ†ç»„ç®¡ç†: http://localhost:${this.port}/groups`);
            console.log(`   å®æ—¶ç›‘æ§: http://localhost:${this.port}/monitor`);
            console.log(`   ç³»ç»Ÿç®¡ç†: http://localhost:${this.port}/admin`);
            console.log(`\nğŸ’¡ æç¤º: è¯·é€šè¿‡Webç•Œé¢æ‰‹åŠ¨æ·»åŠ è®¾å¤‡`);
        });
    }
    
    /**
     * ä¼˜é›…å…³é—­
     */
    stop() {
        console.log('\nğŸ”„ æ­£åœ¨å…³é—­æœåŠ¡å™¨...');
        
        this.discoveryService.stop();
        this.server.close(() => {
            console.log('âœ… æœåŠ¡å™¨å·²å…³é—­');
            process.exit(0);
        });
    }
}

// å¤„ç†é€€å‡ºä¿¡å·
process.on('SIGINT', () => {
    console.log('\næ”¶åˆ°é€€å‡ºä¿¡å· (SIGINT)');
    server.stop();
});

process.on('SIGTERM', () => {
    console.log('\næ”¶åˆ°é€€å‡ºä¿¡å· (SIGTERM)');
    server.stop();
});

// å¯åŠ¨æœåŠ¡å™¨
const server = new DeviceSimulatorServer();
server.start();

module.exports = DeviceSimulatorServer;
