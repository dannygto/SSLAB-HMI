<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»„ç®¡ç† - SSLABè®¾å¤‡æ¨¡æ‹Ÿå™¨</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- ç»Ÿä¸€å¯¼èˆªæ å®¹å™¨ -->
    <div id="navbar-container"></div>

    <div class="container">
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">ğŸ“Š è®¾å¤‡ç»„åˆ—è¡¨</h5>
                            <button class="btn btn-success btn-sm" onclick="showCreateGroupModal()">
                                â• åˆ›å»ºæ–°ç»„
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="groupsList" class="list-group">
                                <!-- åŠ¨æ€åŠ è½½ç»„åˆ—è¡¨ -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">ğŸ“‹ ç»„è¯¦ç»†ä¿¡æ¯</h5>
                        </div>
                        <div class="card-body">
                            <div id="groupDetails">
                                <div class="text-muted text-center py-5">
                                    è¯·é€‰æ‹©ä¸€ä¸ªç»„æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">ğŸ”§ ç»„æ“ä½œ</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <h6>æ‰¹é‡åˆ†é…è®¾å¤‡</h6>
                                    <label for="targetGroupSelect" class="form-label visually-hidden">é€‰æ‹©ç›®æ ‡ç»„</label>
                                    <select class="form-select mb-2" id="targetGroupSelect" aria-label="é€‰æ‹©è¦åˆ†é…è®¾å¤‡çš„ç›®æ ‡ç»„">
                                        <option value="">é€‰æ‹©ç›®æ ‡ç»„</option>
                                    </select>
                                    <div id="unassignedDevices" class="border rounded p-2 unassigned-devices-list" role="list" aria-label="æœªåˆ†é…çš„è®¾å¤‡åˆ—è¡¨">
                                        <!-- æœªåˆ†é…çš„è®¾å¤‡åˆ—è¡¨ -->
                                    </div>
                                    <button class="btn btn-primary btn-sm mt-2" onclick="assignSelectedDevices()">
                                        åˆ†é…é€‰ä¸­è®¾å¤‡
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <h6>ç»„ç»Ÿè®¡ä¿¡æ¯</h6>
                                    <div id="groupStats">
                                        <!-- ç»„ç»Ÿè®¡ä¿¡æ¯ -->
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <h6>å¿«é€Ÿæ“ä½œ</h6>
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-warning btn-sm" onclick="enableAllDevicesInGroup()">
                                            å¯ç”¨ç»„å†…æ‰€æœ‰è®¾å¤‡
                                        </button>
                                        <button class="btn btn-secondary btn-sm" onclick="disableAllDevicesInGroup()">
                                            ç¦ç”¨ç»„å†…æ‰€æœ‰è®¾å¤‡
                                        </button>
                                        <button class="btn btn-info btn-sm" onclick="exportGroupConfig()">
                                            å¯¼å‡ºç»„é…ç½®
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ›å»ºç»„æ¨¡æ€æ¡† -->
    <div class="modal fade" id="createGroupModal" tabindex="-1" aria-labelledby="createGroupModalLabel" aria-describedby="createGroupModalDescription">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createGroupModalLabel">åˆ›å»ºæ–°è®¾å¤‡ç»„</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="å…³é—­"></button>
                </div>
                <div class="modal-body">
                    <div id="createGroupModalDescription" class="visually-hidden">åˆ›å»ºæ–°çš„è®¾å¤‡åˆ†ç»„æ¥ç®¡ç†ç›¸å…³è®¾å¤‡</div>
                    <form id="createGroupForm">
                        <div class="mb-3">
                            <label for="newGroupId" class="form-label">ç»„ID *</label>
                            <input type="text" class="form-control" id="newGroupId" required 
                                   placeholder="ä¾‹ï¼šHX002, SY003">
                        </div>
                        <div class="mb-3">
                            <label for="newGroupName" class="form-label">ç»„åç§° *</label>
                            <input type="text" class="form-control" id="newGroupName" required 
                                   placeholder="ä¾‹ï¼šåå¤æ¥¼202æ•™å®¤">
                        </div>
                        <div class="mb-3">
                            <label for="newGroupDescription" class="form-label">ç»„æè¿°</label>
                            <textarea class="form-control" id="newGroupDescription" rows="3"
                                      placeholder="æè¿°è¿™ä¸ªç»„çš„ç”¨é€”å’Œä½ç½®ä¿¡æ¯"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="newGroupCapacity" class="form-label">è®¾å¤‡å®¹é‡</label>
                            <input type="number" class="form-control" id="newGroupCapacity" min="1" max="100" value="20">
                        </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="createGroup()">åˆ›å»ºç»„</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let groups = {};
        let devices = {};
        let selectedGroupId = null;

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadGroups();
            loadDevices();
            setupSocketListeners();
        });

        // Socketäº‹ä»¶ç›‘å¬
        function setupSocketListeners() {
            socket.on('deviceUpdate', function(device) {
                devices[device.id] = device;
                if (selectedGroupId && device.groupId === selectedGroupId) {
                    showGroupDetails(selectedGroupId);
                }
                updateGroupStats();
            });

            socket.on('deviceStatusChange', function(data) {
                if (devices[data.deviceId]) {
                    devices[data.deviceId].enabled = data.enabled;
                    updateGroupStats();
                }
            });
        }

        // åŠ è½½ç»„åˆ—è¡¨
        async function loadGroups() {
            try {
                const response = await fetch('/api/groups');
                const result = await response.json();
                const data = result.success ? result.data : result;
                groups = {};
                if (Array.isArray(data)) {
                    data.forEach(group => {
                        groups[group.id] = group;
                    });
                }
                displayGroups();
                updateTargetGroupSelect();
            } catch (error) {
                console.error('åŠ è½½ç»„åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // åŠ è½½è®¾å¤‡åˆ—è¡¨
        async function loadDevices() {
            try {
                const response = await fetch('/api/devices');
                const result = await response.json();
                devices = {};
                const data = result.success ? result.data : result;
                if (Array.isArray(data)) {
                    data.forEach(device => {
                        devices[device.id] = device;
                    });
                }
                displayUnassignedDevices();
                updateGroupStats();
            } catch (error) {
                console.error('åŠ è½½è®¾å¤‡åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºç»„åˆ—è¡¨
        function displayGroups() {
            const groupsList = document.getElementById('groupsList');
            groupsList.innerHTML = '';

            Object.values(groups).forEach(group => {
                const deviceCount = Object.values(devices).filter(d => d.groupId === group.id).length;
                const enabledCount = Object.values(devices).filter(d => d.groupId === group.id && d.enabled).length;
                
                const groupItem = document.createElement('div');
                groupItem.className = `list-group-item list-group-item-action ${selectedGroupId === group.id ? 'active' : ''}`;
                groupItem.onclick = () => selectGroup(group.id);
                
                groupItem.innerHTML = `
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">${group.name || group.id}</h6>
                        <small class="text-muted">${enabledCount}/${deviceCount} è®¾å¤‡</small>
                    </div>
                    <p class="mb-1">${group.description || 'æ— æè¿°'}</p>
                    <small class="text-muted">ç»„ID: ${group.id}</small>
                `;
                
                groupsList.appendChild(groupItem);
            });
        }

        // é€‰æ‹©ç»„
        function selectGroup(groupId) {
            selectedGroupId = groupId;
            displayGroups(); // é‡æ–°æ˜¾ç¤ºä»¥æ›´æ–°é€‰ä¸­çŠ¶æ€
            showGroupDetails(groupId);
        }

        // æ˜¾ç¤ºç»„è¯¦ç»†ä¿¡æ¯
        function showGroupDetails(groupId) {
            const group = groups[groupId];
            const groupDevices = Object.values(devices).filter(d => d.groupId === groupId);
            
            const groupDetails = document.getElementById('groupDetails');
            groupDetails.innerHTML = `
                <div class="mb-3">
                    <h6>ğŸ“‹ åŸºæœ¬ä¿¡æ¯</h6>
                    <p><strong>ç»„ID:</strong> ${group.id}</p>
                    <p><strong>ç»„åç§°:</strong> ${group.name || 'æœªè®¾ç½®'}</p>
                    <p><strong>æè¿°:</strong> ${group.description || 'æ— æè¿°'}</p>
                    <p><strong>è®¾å¤‡å®¹é‡:</strong> ${group.capacity || 'æ— é™åˆ¶'}</p>
                </div>
                
                <div class="mb-3">
                    <h6>ğŸ“Š ç»Ÿè®¡ä¿¡æ¯</h6>
                    <p><strong>è®¾å¤‡æ€»æ•°:</strong> ${groupDevices.length}</p>
                    <p><strong>åœ¨çº¿è®¾å¤‡:</strong> ${groupDevices.filter(d => d.enabled).length}</p>
                    <p><strong>ç¦»çº¿è®¾å¤‡:</strong> ${groupDevices.filter(d => !d.enabled).length}</p>
                </div>
                
                <div class="mb-3">
                    <h6>ğŸ”§ è®¾å¤‡åˆ—è¡¨</h6>
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>è®¾å¤‡åç§°</th>
                                    <th>ç±»å‹</th>
                                    <th>çŠ¶æ€</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${groupDevices.map(device => `
                                    <tr>
                                        <td>${device.name}</td>
                                        <td>${device.type}</td>
                                        <td>
                                            <span class="badge ${device.enabled ? 'bg-success' : 'bg-secondary'}">
                                                ${device.enabled ? 'åœ¨çº¿' : 'ç¦»çº¿'}
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm ${device.enabled ? 'btn-warning' : 'btn-success'}" 
                                                    onclick="toggleDevice('${device.id}')">
                                                ${device.enabled ? 'ç¦ç”¨' : 'å¯ç”¨'}
                                            </button>
                                            <button class="btn btn-sm btn-danger" onclick="removeDeviceFromGroup('${device.id}')">
                                                ç§»é™¤
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="mt-3">
                    <button class="btn btn-warning btn-sm me-2" onclick="editGroup('${groupId}')">ç¼–è¾‘ç»„</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteGroup('${groupId}')">åˆ é™¤ç»„</button>
                </div>
            `;
        }

        // æ˜¾ç¤ºæœªåˆ†é…çš„è®¾å¤‡
        function displayUnassignedDevices() {
            const unassignedDevices = Object.values(devices).filter(d => !d.groupId || d.groupId === '');
            const container = document.getElementById('unassignedDevices');
            
            container.innerHTML = unassignedDevices.map(device => `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="${device.id}" id="device_${device.id}">
                    <label class="form-check-label" for="device_${device.id}">
                        ${device.name} (${device.type})
                    </label>
                </div>
            `).join('') || '<div class="text-muted">æ‰€æœ‰è®¾å¤‡éƒ½å·²åˆ†é…</div>';
        }

        // æ›´æ–°ç›®æ ‡ç»„é€‰æ‹©æ¡†
        function updateTargetGroupSelect() {
            const select = document.getElementById('targetGroupSelect');
            select.innerHTML = '<option value="">é€‰æ‹©ç›®æ ‡ç»„</option>';
            
            Object.values(groups).forEach(group => {
                const option = document.createElement('option');
                option.value = group.id;
                option.textContent = `${group.name || group.id} (${group.id})`;
                select.appendChild(option);
            });
        }

        // æ›´æ–°ç»„ç»Ÿè®¡ä¿¡æ¯
        function updateGroupStats() {
            const stats = {};
            Object.values(groups).forEach(group => {
                const groupDevices = Object.values(devices).filter(d => d.groupId === group.id);
                stats[group.id] = {
                    total: groupDevices.length,
                    enabled: groupDevices.filter(d => d.enabled).length
                };
            });

            const container = document.getElementById('groupStats');
            container.innerHTML = Object.entries(stats).map(([groupId, stat]) => `
                <div class="mb-2">
                    <strong>${groups[groupId]?.name || groupId}:</strong> ${stat.enabled}/${stat.total} åœ¨çº¿
                </div>
            `).join('') || '<div class="text-muted">æš‚æ— æ•°æ®</div>';
        }

        // æ˜¾ç¤ºåˆ›å»ºç»„æ¨¡æ€æ¡†
        function showCreateGroupModal() {
            new bootstrap.Modal(document.getElementById('createGroupModal')).show();
        }

        // åˆ›å»ºç»„
        async function createGroup() {
            const groupId = document.getElementById('newGroupId').value.trim();
            const groupName = document.getElementById('newGroupName').value.trim();
            const groupDescription = document.getElementById('newGroupDescription').value.trim();
            const groupCapacity = parseInt(document.getElementById('newGroupCapacity').value);

            if (!groupId || !groupName) {
                alert('è¯·å¡«å†™å¿…å¡«å­—æ®µ');
                return;
            }

            if (groups[groupId]) {
                alert('ç»„IDå·²å­˜åœ¨');
                return;
            }

            try {
                const response = await fetch('/api/groups', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        groupId: groupId,
                        name: groupName,
                        description: groupDescription,
                        capacity: groupCapacity
                    })
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('createGroupModal')).hide();
                    document.getElementById('createGroupForm').reset();
                    await loadGroups();
                    alert('ç»„åˆ›å»ºæˆåŠŸ');
                } else {
                    alert('åˆ›å»ºç»„å¤±è´¥');
                }
            } catch (error) {
                console.error('åˆ›å»ºç»„å¤±è´¥:', error);
                alert('åˆ›å»ºç»„å¤±è´¥');
            }
        }

        // åˆ†é…é€‰ä¸­çš„è®¾å¤‡
        async function assignSelectedDevices() {
            const targetGroupId = document.getElementById('targetGroupSelect').value;
            if (!targetGroupId) {
                alert('è¯·é€‰æ‹©ç›®æ ‡ç»„');
                return;
            }

            const checkboxes = document.querySelectorAll('#unassignedDevices input[type="checkbox"]:checked');
            const deviceIds = Array.from(checkboxes).map(cb => cb.value);

            if (deviceIds.length === 0) {
                alert('è¯·é€‰æ‹©è¦åˆ†é…çš„è®¾å¤‡');
                return;
            }

            try {
                const results = [];
                for (const deviceId of deviceIds) {
                    const response = await fetch(`/api/devices/${deviceId}/group`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ groupId: targetGroupId })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        console.error(`è®¾å¤‡ ${deviceId} åˆ†é…å¤±è´¥:`, errorData);
                        results.push({ deviceId, success: false, error: errorData.error || 'æœªçŸ¥é”™è¯¯' });
                    } else {
                        results.push({ deviceId, success: true });
                    }
                }
                
                const failures = results.filter(r => !r.success);
                if (failures.length > 0) {
                    console.error('åˆ†é…å¤±è´¥çš„è®¾å¤‡:', failures);
                    alert(`éƒ¨åˆ†è®¾å¤‡åˆ†é…å¤±è´¥: ${failures.map(f => f.deviceId).join(', ')}`);
                } else {
                    alert('æ‰€æœ‰è®¾å¤‡åˆ†é…æˆåŠŸ');
                }
                
                await loadDevices();
            } catch (error) {
                console.error('åˆ†é…è®¾å¤‡æ—¶æœ‰é”™è¯¯:', error);
                alert('åˆ†é…è®¾å¤‡æ—¶æœ‰é”™è¯¯');
            }
        }

        // åˆ‡æ¢è®¾å¤‡çŠ¶æ€
        async function toggleDevice(deviceId) {
            try {
                const device = devices[deviceId];
                const response = await fetch(`/api/devices/${deviceId}/toggle`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    await loadDevices();
                    if (selectedGroupId) {
                        showGroupDetails(selectedGroupId);
                    }
                }
            } catch (error) {
                console.error('åˆ‡æ¢è®¾å¤‡çŠ¶æ€å¤±è´¥:', error);
            }
        }

        // ä»ç»„ä¸­ç§»é™¤è®¾å¤‡
        async function removeDeviceFromGroup(deviceId) {
            if (!confirm('ç¡®è®¤è¦å°†æ­¤è®¾å¤‡ä»ç»„ä¸­ç§»é™¤å—ï¼Ÿ')) return;

            try {
                await fetch(`/api/devices/${deviceId}/group`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ groupId: '' })
                });
                
                await loadDevices();
                if (selectedGroupId) {
                    showGroupDetails(selectedGroupId);
                }
                alert('è®¾å¤‡å·²ä»ç»„ä¸­ç§»é™¤');
            } catch (error) {
                console.error('ç§»é™¤è®¾å¤‡å¤±è´¥:', error);
                alert('ç§»é™¤è®¾å¤‡å¤±è´¥');
            }
        }

        // å¯ç”¨ç»„å†…æ‰€æœ‰è®¾å¤‡
        async function enableAllDevicesInGroup() {
            if (!selectedGroupId) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç»„');
                return;
            }

            try {
                const response = await fetch(`/api/groups/${selectedGroupId}/enable-all`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    await loadDevices();
                    showGroupDetails(selectedGroupId);
                    alert('å·²å¯ç”¨ç»„å†…æ‰€æœ‰è®¾å¤‡');
                }
            } catch (error) {
                console.error('å¯ç”¨è®¾å¤‡å¤±è´¥:', error);
                alert('å¯ç”¨è®¾å¤‡å¤±è´¥');
            }
        }

        // ç¦ç”¨ç»„å†…æ‰€æœ‰è®¾å¤‡
        async function disableAllDevicesInGroup() {
            if (!selectedGroupId) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç»„');
                return;
            }

            if (!confirm('ç¡®è®¤è¦ç¦ç”¨ç»„å†…æ‰€æœ‰è®¾å¤‡å—ï¼Ÿ')) return;

            try {
                const response = await fetch(`/api/groups/${selectedGroupId}/disable-all`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    await loadDevices();
                    showGroupDetails(selectedGroupId);
                    alert('å·²ç¦ç”¨ç»„å†…æ‰€æœ‰è®¾å¤‡');
                }
            } catch (error) {
                console.error('ç¦ç”¨è®¾å¤‡å¤±è´¥:', error);
                alert('ç¦ç”¨è®¾å¤‡å¤±è´¥');
            }
        }

        // å¯¼å‡ºç»„é…ç½®
        function exportGroupConfig() {
            if (!selectedGroupId) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç»„');
                return;
            }

            const group = groups[selectedGroupId];
            const groupDevices = Object.values(devices).filter(d => d.groupId === selectedGroupId);
            
            const config = {
                group: group,
                devices: groupDevices,
                exportTime: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `group_${selectedGroupId}_config.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ç¼–è¾‘ç»„
        function editGroup(groupId) {
            alert('ç¼–è¾‘ç»„åŠŸèƒ½å¾…å®ç°');
        }

        // åˆ é™¤ç»„
        async function deleteGroup(groupId) {
            if (!confirm(`ç¡®è®¤è¦åˆ é™¤ç»„ ${groups[groupId]?.name || groupId} å—ï¼Ÿ`)) return;

            try {
                const response = await fetch(`/api/groups/${groupId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    await loadGroups();
                    await loadDevices();
                    if (selectedGroupId === groupId) {
                        selectedGroupId = null;
                        document.getElementById('groupDetails').innerHTML = `
                            <div class="text-muted text-center py-5">
                                è¯·é€‰æ‹©ä¸€ä¸ªç»„æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
                            </div>
                        `;
                    }
                    alert('ç»„åˆ é™¤æˆåŠŸ');
                }
            } catch (error) {
                console.error('åˆ é™¤ç»„å¤±è´¥:', error);
                alert('åˆ é™¤ç»„å¤±è´¥');
            }
        }
    </script>
    
    <!-- å¯¼èˆªæ ç»„ä»¶åŠ è½½å™¨ -->
    <script src="js/navbar.js"></script>
</body>
</html>
