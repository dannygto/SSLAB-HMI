<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®æ—¶ç›‘æ§ - SSLABè®¾å¤‡æ¨¡æ‹Ÿå™¨</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- ç»Ÿä¸€å¯¼èˆªæ å®¹å™¨ -->
    <div id="navbar-container"></div>

    <div class="container">
            <!-- æ§åˆ¶é¢æ¿ -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">ğŸ“Š ç›‘æ§æ§åˆ¶é¢æ¿</h5>
                            <div>
                                <button class="btn btn-success btn-sm me-2" onclick="startMonitoring()">
                                    â–¶ï¸ å¼€å§‹ç›‘æ§
                                </button>
                                <button class="btn btn-warning btn-sm me-2" onclick="pauseMonitoring()">
                                    â¸ï¸ æš‚åœ
                                </button>
                                <button class="btn btn-danger btn-sm me-2" onclick="stopMonitoring()">
                                    â¹ï¸ åœæ­¢
                                </button>
                                <select class="form-select refresh-interval-select" id="refreshInterval" title="åˆ·æ–°é—´éš”">
                                    <option value="1000">1ç§’</option>
                                    <option value="3000" selected>3ç§’</option>
                                    <option value="5000">5ç§’</option>
                                    <option value="10000">10ç§’</option>
                                </select>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="border rounded p-3 text-center">
                                        <h6>ğŸ“ˆ ç›‘æ§çŠ¶æ€</h6>
                                        <span id="monitoringStatus" class="badge bg-secondary">æœªå¯åŠ¨</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="border rounded p-3 text-center">
                                        <h6>ğŸ”¢ æ€»è®¾å¤‡æ•°</h6>
                                        <span id="totalDevices" class="h4 text-primary">0</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="border rounded p-3 text-center">
                                        <h6>ğŸ”— åœ¨çº¿è®¾å¤‡</h6>
                                        <span id="onlineDevices" class="h4 text-success">0</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="border rounded p-3 text-center">
                                        <h6>âš ï¸ ç¦»çº¿è®¾å¤‡</h6>
                                        <span id="offlineDevices" class="h4 text-danger">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è®¾å¤‡çŠ¶æ€å›¾è¡¨ -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">ğŸ“Š è®¾å¤‡çŠ¶æ€åˆ†å¸ƒ</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="deviceStatusChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">ğŸ“ˆ è®¾å¤‡ç±»å‹åˆ†å¸ƒ</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="deviceTypeChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å®æ—¶æ•°æ®æµ -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">ğŸ“¡ å®æ—¶æ•°æ®æµ</h6>
                            <div>
                                <button class="btn btn-outline-secondary btn-sm" onclick="clearDataStream()">
                                    ğŸ§¹ æ¸…ç©º
                                </button>
                                <button class="btn btn-outline-primary btn-sm" onclick="exportDataStream()">
                                    ğŸ’¾ å¯¼å‡º
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="dataStream" class="border rounded p-3 bg-dark text-light font-monospace data-stream">
                                <div class="text-muted">ç­‰å¾…æ•°æ®ä¸­...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let devices = {};
        let groups = {};
        let monitoring = false;
        let monitoringInterval = null;
        let dataStreamData = [];
        
        // å›¾è¡¨å®ä¾‹
        let deviceStatusChart = null;
        let deviceTypeChart = null;

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            loadInitialData();
            setupSocketListeners();
            updateRefreshInterval();
        });

        // åˆå§‹åŒ–å›¾è¡¨
        function initializeCharts() {
            // è®¾å¤‡çŠ¶æ€å›¾è¡¨
            const statusCtx = document.getElementById('deviceStatusChart').getContext('2d');
            deviceStatusChart = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['åœ¨çº¿', 'ç¦»çº¿'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: ['#28a745', '#dc3545']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // è®¾å¤‡ç±»å‹å›¾è¡¨
            const typeCtx = document.getElementById('deviceTypeChart').getContext('2d');
            deviceTypeChart = new Chart(typeCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'è®¾å¤‡æ•°é‡',
                        data: [],
                        backgroundColor: '#007bff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // åŠ è½½åˆå§‹æ•°æ®
        async function loadInitialData() {
            try {
                // åŠ è½½è®¾å¤‡
                const devicesResponse = await fetch('/api/devices');
                const devicesResult = await devicesResponse.json();
                devices = {};
                const devicesData = devicesResult.success ? devicesResult.data : devicesResult;
                if (Array.isArray(devicesData)) {
                    devicesData.forEach(device => {
                        devices[device.id] = device;
                    });
                }

                // åŠ è½½ä¸­
                const groupsResponse = await fetch('/api/groups');
                const groupsResult = await groupsResponse.json();
                groups = {};
                const groupsData = groupsResult.success ? groupsResult.data : groupsResult;
                if (Array.isArray(groupsData)) {
                    groupsData.forEach(group => {
                        groups[group.id] = group;
                    });
                }

                updateUI();
            } catch (error) {
                console.error('åŠ è½½åˆå§‹æ•°æ®å¤±è´¥:', error);
            }
        }

        // Socketäº‹ä»¶ç›‘å¬
        function setupSocketListeners() {
            socket.on('deviceUpdate', function(device) {
                devices[device.id] = device;
                updateUI();
                addDataStream('DEVICE_UPDATE', device);
            });

            socket.on('deviceStatusChange', function(data) {
                if (devices[data.deviceId]) {
                    devices[data.deviceId].enabled = data.enabled;
                    updateUI();
                    addDataStream('STATUS_CHANGE', data);
                }
            });

            // è®¾å¤‡æ§åˆ¶æˆåŠŸäº‹ä»¶
            socket.on('device:control:success', function(data) {
                // åˆ·æ–°è®¾å¤‡æ•°æ®
                socket.emit('devices:get');
            });

            // è®¾å¤‡æ§åˆ¶å¤±è´¥äº‹ä»¶
            socket.on('device:control:error', function(data) {
                alert(`è®¾å¤‡æ§åˆ¶å¤±è´¥: ${data.error}`);
            });
        }

        // æ›´æ–°åˆ·æ–°é—´éš”
        function updateRefreshInterval() {
            document.getElementById('refreshInterval').addEventListener('change', function() {
                if (monitoring) {
                    stopMonitoring();
                    startMonitoring();
                }
            });
        }

        // å¼€å§‹ç›‘æ§
        function startMonitoring() {
            if (monitoring) return;
            
            monitoring = true;
            const interval = parseInt(document.getElementById('refreshInterval').value);
            
            monitoringInterval = setInterval(() => {
                refreshDeviceData();
            }, interval);
            
            document.getElementById('monitoringStatus').textContent = 'è¿è¡Œä¸­';
            document.getElementById('monitoringStatus').className = 'badge bg-success';
        }

        // æš‚åœç›‘æ§
        function pauseMonitoring() {
            if (!monitoring) return;
            
            monitoring = false;
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
            }
            
            document.getElementById('monitoringStatus').textContent = 'å·²æš‚åœ';
            document.getElementById('monitoringStatus').className = 'badge bg-warning';
        }

        // åœæ­¢ç›‘æ§
        function stopMonitoring() {
            pauseMonitoring();
            
            document.getElementById('monitoringStatus').textContent = 'å·²åœæ­¢';
            document.getElementById('monitoringStatus').className = 'badge bg-danger';
        }

        // åˆ·æ–°è®¾å¤‡æ•°æ®
        async function refreshDeviceData() {
            try {
                const response = await fetch('/api/devices');
                const result = await response.json();
                const data = result.success ? result.data : result;
                
                if (Array.isArray(data)) {
                    data.forEach(device => {
                        if (devices[device.id]) {
                            const oldData = JSON.stringify(devices[device.id].data || {});
                            const newData = JSON.stringify(device.data || {});
                            
                            if (oldData !== newData) {
                                addDataStream('DATA_REFRESH', device);
                            }
                        }
                        devices[device.id] = device;
                    });
                    
                    updateUI();
                }
            } catch (error) {
                console.error('åˆ·æ–°è®¾å¤‡æ•°æ®å¤±è´¥:', error);
            }
        }

        // æ›´æ–°UI
        function updateUI() {
            updateDeviceCounts();
            updateCharts();
        }

        // æ›´æ–°è®¾å¤‡è®¡æ•°
        function updateDeviceCounts() {
            const deviceList = Object.values(devices);
            const total = deviceList.length;
            const online = deviceList.filter(d => d.enabled).length;
            const offline = total - online;

            document.getElementById('totalDevices').textContent = total;
            document.getElementById('onlineDevices').textContent = online;
            document.getElementById('offlineDevices').textContent = offline;
        }

        // æ›´æ–°å›¾è¡¨
        function updateCharts() {
            const deviceList = Object.values(devices);
            const online = deviceList.filter(d => d.enabled).length;
            const offline = deviceList.length - online;

            // æ›´æ–°çŠ¶æ€å›¾è¡¨
            deviceStatusChart.data.datasets[0].data = [online, offline];
            deviceStatusChart.update();

            // æ›´æ–°ç±»å‹å›¾è¡¨
            const typeCounts = {};
            deviceList.forEach(device => {
                typeCounts[device.type] = (typeCounts[device.type] || 0) + 1;
            });

            deviceTypeChart.data.labels = Object.keys(typeCounts);
            deviceTypeChart.data.datasets[0].data = Object.values(typeCounts);
            deviceTypeChart.update();
        }

        // æ·»åŠ æ•°æ®æµ
        function addDataStream(type, data) {
            const timestamp = new Date().toLocaleTimeString();
            const entry = {
                timestamp,
                type,
                data
            };
            
            dataStreamData.unshift(entry);
            if (dataStreamData.length > 100) {
                dataStreamData.pop();
            }

            const streamDiv = document.getElementById('dataStream');
            const entryDiv = document.createElement('div');
            entryDiv.className = 'mb-1';
            entryDiv.innerHTML = `
                <span class="text-warning">[${timestamp}]</span> 
                <span class="text-info">${type}</span>: 
                <span class="text-light">${JSON.stringify(data).substring(0, 100)}...</span>
            `;
            
            streamDiv.insertBefore(entryDiv, streamDiv.firstChild);
            
            // ä¿æŒæœ€ï¿½?0ä¸ªæ¡ç›®æ˜¾ï¿½?
            while (streamDiv.children.length > 50) {
                streamDiv.removeChild(streamDiv.lastChild);
            }
        }

        // æ¸…ç©ºæ•°æ®ï¿½?
        function clearDataStream() {
            dataStreamData = [];
            document.getElementById('dataStream').innerHTML = '<div class="text-muted">æ•°æ®æµå·²æ¸…ç©º</div>';
        }

        // å¯¼å‡ºæ•°æ®ï¿½?
        function exportDataStream() {
            const data = {
                exportTime: new Date().toISOString(),
                devices: devices,
                dataStream: dataStreamData
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `monitor_data_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // è‡ªåŠ¨å¼€å§‹ç›‘ï¿½?
        setTimeout(() => {
            startMonitoring();
        }, 1000);
    </script>
    
    <!-- å¯¼èˆªæ ç»„ä»¶åŠ è½½å™¨ -->
    <script src="js/navbar.js"></script>
</body>
</html>
