<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>设备管理 - SSLAB设备模拟器</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        .device-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .device-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .device-online {
            border-left: 4px solid #28a745;
        }
        .device-offline {
            border-left: 4px solid #dc3545;
        }
        .device-connecting {
            border-left: 4px solid #ffc107;
        }
        .control-buttons {
            display: none;
        }
        .device-card:hover .control-buttons {
            display: block;
        }
        .device-type-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
        }
        .search-section {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .form-select {
            font-size: 0.875rem;
            max-width: 100%;
            word-wrap: break-word;
        }
        .form-select-sm {
            font-size: 0.8rem;
            padding: 0.25rem 1.75rem 0.25rem 0.5rem;
            max-width: 100%;
        }
        .form-select option {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }
        .modal-body select.form-select {
            width: 100%;
            box-sizing: border-box;
        }
        
        #bulkActionsToolbar {
            display: none;
        }
        .search-flex-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }
        .search-input-container {
            flex: 1;
            min-width: 200px;
        }
        .filter-select-type {
            min-width: 120px;
        }
        .filter-select-status {
            min-width: 80px;
        }
        .filter-select-group {
            min-width: 100px;
        }
        .table-controls {
            background-color: #fff;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        /* 设备详情对象显示样式 */
        .object-details {
            background-color: #f8f9fa;
            border-radius: 4px;
            padding: 8px;
            margin: 2px 0;
            font-size: 0.875rem;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .object-details div {
            margin: 2px 0;
            padding: 2px 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .object-details div:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <!-- 统一导航栏容器 -->
    <div id="navbar-container"></div>

    <div class="container">
        <!-- 搜索和过滤 -->
        <div class="search-section">
            <div class="search-flex-container">
                <div class="search-input-container">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" id="searchInput" placeholder="搜索设备名称、IP地址...">
                    </div>
                </div>
                <div class="filter-select-type">
                    <select class="form-select form-select-sm" id="typeFilter" title="按设备类型筛选">
                        <option value="">所有类型</option>
                        <option value="ENVIRONMENT_MONITOR">环境检测</option>
                        <option value="STUDENT_POWER_TERMINAL">电源终端</option>
                        <option value="ENVIRONMENT_CONTROLLER">环境控制</option>
                        <option value="CURTAIN_CONTROLLER">窗帘控制</option>
                        <option value="LIGHTING_CONTROLLER">灯光控制</option>
                        <option value="LIFT_CONTROLLER">升降控制</option>
                        <option value="INTERACTIVE_STUDENT_TERMINAL">互动学生终端</option>
                        <option value="INTERACTIVE_DISPLAY">互动教学显示器</option>
                        <option value="INTERACTIVE_CONTROLLER">互动教学控制器</option>
                    </select>
                </div>
                <div class="filter-select-status">
                    <select class="form-select form-select-sm" id="statusFilter" title="按状态筛选">
                        <option value="">状态</option>
                        <option value="ONLINE">在线</option>
                        <option value="OFFLINE">离线</option>
                        <option value="CONNECTING">连接中</option>
                    </select>
                </div>
                <div class="filter-select-group">
                    <select class="form-select form-select-sm" id="groupFilter" title="按分组筛选">
                        <option value="">所有分组</option>
                    </select>
                </div>
                <div>
                    <button class="btn btn-outline-secondary btn-sm" onclick="clearFilters()" title="清除所有筛选条件">
                        <i class="bi bi-x-circle"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- 控制面板 -->
        <div class="table-controls">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h5 class="mb-0">
                        <i class="bi bi-hdd-stack"></i> 设备列表 
                        <span class="badge bg-primary" id="deviceCount">0</span>
                    </h5>
                </div>
                <div class="col-md-6 text-end">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-success" onclick="showAddDeviceModal()">
                            <i class="bi bi-plus-circle"></i> 添加设备
                        </button>
                        <button type="button" class="btn btn-warning" onclick="addTestDevices()">
                            <i class="bi bi-lightning"></i> 一键添加测试设备
                        </button>
                        <button type="button" class="btn btn-info" onclick="refreshDevices()">
                            <i class="bi bi-arrow-clockwise"></i> 刷新
                        </button>
                        <button type="button" class="btn btn-outline-primary" onclick="toggleView()">
                            <i class="bi bi-grid-3x3-gap" id="viewToggleIcon"></i> <span id="viewToggleText">卡片视图</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 设备列表容器 -->
        <div id="devicesContainer">
            <!-- 动态生成设备列表 -->
        </div>

        <!-- 批量操作工具栏 -->
        <div id="bulkActionsToolbar" class="fixed-bottom bg-dark text-white p-3">
            <div class="container-fluid">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <span id="selectedCount">0</span> 个设备已选中
                    </div>
                    <div class="col-md-6 text-end">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-success btn-sm" onclick="bulkControl('turnOn')">
                                <i class="bi bi-power"></i> 开启
                            </button>
                            <button type="button" class="btn btn-danger btn-sm" onclick="bulkControl('turnOff')">
                                <i class="bi bi-stop"></i> 关闭
                            </button>
                            <button type="button" class="btn btn-warning btn-sm" onclick="bulkControl('toggle')">
                                <i class="bi bi-arrow-repeat"></i> 切换
                            </button>
                            <button type="button" class="btn btn-outline-light btn-sm" onclick="clearSelection()">
                                <i class="bi bi-x"></i> 取消选择
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加设备模态框 -->
    <div class="modal fade" id="addDeviceModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加新设备</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
                </div>
                <div class="modal-body">
                    <form id="addDeviceForm">
                        <div class="mb-3">
                            <label for="deviceName" class="form-label">设备名称</label>
                            <input type="text" class="form-control" id="deviceName" required>
                        </div>
                        <div class="mb-3">
                            <label for="deviceType" class="form-label">设备类型</label>
                            <select class="form-select" id="deviceType" required>
                                <option value="">请选择...</option>
                                <option value="ENVIRONMENT_MONITOR">环境检测装置</option>
                                <option value="STUDENT_POWER_TERMINAL">学生电源终端</option>
                                <option value="ENVIRONMENT_CONTROLLER">环境控制装置</option>
                                <option value="CURTAIN_CONTROLLER">窗帘控制装置</option>
                                <option value="LIGHTING_CONTROLLER">灯光控制装置</option>
                                <option value="LIFT_CONTROLLER">升降控制装置</option>
                                <option value="INTERACTIVE_STUDENT_TERMINAL">互动教学学生终端</option>
                                <option value="INTERACTIVE_DISPLAY">互动教学显示设备</option>
                                <option value="INTERACTIVE_CONTROLLER">互动教学控制器</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="deviceGroupId" class="form-label">设备分组</label>
                            <select class="form-select" id="deviceGroupId">
                                <option value="">无分组</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="deviceIP" class="form-label">IP地址（可选）</label>
                            <input type="text" class="form-control" id="deviceIP" placeholder="自动生成">
                        </div>
                        <div class="mb-3">
                            <label for="devicePort" class="form-label">端口（可选）</label>
                            <input type="number" class="form-control" id="devicePort" placeholder="80" min="1" max="65535">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="addDevice()">添加设备</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 设备详情模态框 -->
    <div class="modal fade" id="deviceDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">设备详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
                </div>
                <div class="modal-body" id="deviceDetailContent">
                    <!-- 动态生成设备详情 -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" id="editDeviceBtn" onclick="editDevice()">编辑设备</button>
                    <button type="button" class="btn btn-danger" id="deleteDeviceBtn" onclick="deleteDevice()">删除设备</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Socket.IO -->
    <script src="/socket.io/socket.io.js"></script>
    
    <script>
        // Socket.IO连接
        const socket = io();
        
        // 全局状态
        let allDevices = [];
        let filteredDevices = [];
        let selectedDevices = new Set();
        let currentView = 'card'; // 'card' or 'table'
        let currentDevice = null;

        // 连接状态管理
        socket.on('connect', () => {
            const statusElement = document.getElementById('connectionStatus');
            if (statusElement) {
                statusElement.textContent = '已连接';
                statusElement.className = 'badge bg-success';
            }
            console.log('🟢 WebSocket已连接');
        });

        socket.on('disconnect', () => {
            const statusElement = document.getElementById('connectionStatus');
            if (statusElement) {
                statusElement.textContent = '已断开';
                statusElement.className = 'badge bg-danger';
            }
            console.log('🔴 WebSocket已断开');
        });

        // 接收设备列表
        socket.on('devices:list', (devices) => {
            allDevices = devices;
            applyFilters();
        });

        // 接收分组列表
        socket.on('groups:list', (groups) => {
            updateGroupFilters(groups);
        });

        // 设备事件监听
        socket.on('device:deviceAdded', (device) => {
            allDevices.push(device);
            applyFilters();
            showToast('设备添加成功', 'success');
        });

        socket.on('device:deviceRemoved', (device) => {
            allDevices = allDevices.filter(d => d.id !== device.id);
            applyFilters();
            showToast('设备删除成功', 'warning');
        });

        socket.on('device:deviceControlled', (data) => {
            const device = allDevices.find(d => d.id === data.deviceId);
            if (device) {
                Object.assign(device, data.result);
                updateDeviceCard(device);
            }
        });

        // 设备操作响应
        socket.on('device:add:success', (device) => {
            console.log('设备添加成功:', device);
            bootstrap.Modal.getInstance(document.getElementById('addDeviceModal')).hide();
            document.getElementById('addDeviceForm').reset();
            showToast('设备添加成功: ' + device.name, 'success');
            // 刷新设备列表
            socket.emit('devices:get');
        });

        socket.on('device:add:error', (error) => {
            console.log('设备添加失败:', error);
            showToast('添加设备失败: ' + error.error, 'danger');
        });

        socket.on('device:control:success', (data) => {
            showToast('设备控制成功', 'success');
        });

        socket.on('device:control:error', (error) => {
            showToast('设备控制失败: ' + error.error, 'danger');
        });

        socket.on('devices:control:batch:success', (result) => {
            showToast(`批量操作完成: ${result.results.length}个成功, ${result.errors.length}个失败`, 'info');
        });

        // 更新分组过滤器
        function updateGroupFilters(groups) {
            const groupFilter = document.getElementById('groupFilter');
            const deviceGroupId = document.getElementById('deviceGroupId');
            
            // 清空现有选项（保留"所有分组"选项）
            groupFilter.innerHTML = '<option value="">所有分组</option>';
            deviceGroupId.innerHTML = '<option value="">无分组</option>';
            
            groups.forEach(group => {
                groupFilter.innerHTML += `<option value="${group.groupId}">${group.groupId} - ${group.name}</option>`;
                deviceGroupId.innerHTML += `<option value="${group.groupId}">${group.groupId} - ${group.name}</option>`;
            });
        }

        // 应用过滤器
        function applyFilters() {
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            const typeFilter = document.getElementById('typeFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const groupFilter = document.getElementById('groupFilter').value;

            filteredDevices = allDevices.filter(device => {
                const matchesSearch = !searchText || 
                    device.name.toLowerCase().includes(searchText) ||
                    device.ipAddress.includes(searchText) ||
                    device.type.toLowerCase().includes(searchText);
                
                const matchesType = !typeFilter || device.type === typeFilter;
                const matchesStatus = !statusFilter || device.status === statusFilter;
                const matchesGroup = !groupFilter || device.groupId === groupFilter;

                return matchesSearch && matchesType && matchesStatus && matchesGroup;
            });

            updateDeviceDisplay();
            updateDeviceCount();
        }

        // 更新设备显示
        function updateDeviceDisplay() {
            const container = document.getElementById('devicesContainer');
            
            if (filteredDevices.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-inbox display-1 text-muted"></i>
                        <h4 class="text-muted mt-3">没有找到设备</h4>
                        <p class="text-muted">尝试调整搜索条件或添加新设备</p>
                    </div>
                `;
                return;
            }

            if (currentView === 'card') {
                renderCardView();
            } else {
                renderTableView();
            }
        }

        // 渲染卡片视图
        function renderCardView() {
            const container = document.getElementById('devicesContainer');
            let html = '<div class="row">';

            filteredDevices.forEach(device => {
                const statusClass = `device-${device.status.toLowerCase()}`;
                const typeDisplayName = getTypeDisplayName(device.type);
                const statusIcon = getStatusIcon(device.status);
                
                html += `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card device-card ${statusClass}" onclick="showDeviceDetail('${device.id}')">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0">${device.name}</h6>
                                    <div>
                                        <input type="checkbox" class="form-check-input me-2" onclick="event.stopPropagation(); toggleSelection('${device.id}')" 
                                               ${selectedDevices.has(device.id) ? 'checked' : ''}>
                                        <span class="badge bg-secondary device-type-badge">${typeDisplayName}</span>
                                    </div>
                                </div>
                                
                                <div class="mb-2">
                                    <small class="text-muted">
                                        <i class="bi bi-router"></i> ${device.ipAddress}:${device.port}
                                        ${device.groupId ? `<br><i class="bi bi-collection"></i> ${device.groupId}` : ''}
                                    </small>
                                </div>
                                
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="badge bg-${getStatusColor(device.status)}">
                                        <i class="${statusIcon}"></i> ${getStatusDisplayName(device.status)}
                                    </span>
                                    
                                    <div class="control-buttons">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" class="btn btn-outline-success" onclick="event.stopPropagation(); controlDevice('${device.id}', 'turnOn')"
                                                    ${device.status !== 'ONLINE' ? 'disabled' : ''}>
                                                <i class="bi bi-power"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-danger" onclick="event.stopPropagation(); controlDevice('${device.id}', 'turnOff')"
                                                    ${device.status !== 'ONLINE' ? 'disabled' : ''}>
                                                <i class="bi bi-stop"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-primary" onclick="event.stopPropagation(); controlDevice('${device.id}', 'toggle')"
                                                    ${device.status !== 'ONLINE' ? 'disabled' : ''}>
                                                <i class="bi bi-arrow-repeat"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // 渲染表格视图
        function renderTableView() {
            const container = document.getElementById('devicesContainer');
            let html = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th width="30">
                                    <input type="checkbox" class="form-check-input" onchange="toggleAllSelection(this.checked)">
                                </th>
                                <th>设备名称</th>
                                <th>类型</th>
                                <th>分组</th>
                                <th>IP地址</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            filteredDevices.forEach(device => {
                const typeDisplayName = getTypeDisplayName(device.type);
                const statusIcon = getStatusIcon(device.status);
                
                html += `
                    <tr onclick="showDeviceDetail('${device.id}')" style="cursor: pointer;">
                        <td onclick="event.stopPropagation();">
                            <input type="checkbox" class="form-check-input" onchange="toggleSelection('${device.id}')" 
                                   ${selectedDevices.has(device.id) ? 'checked' : ''}>
                        </td>
                        <td>${device.name}</td>
                        <td><span class="badge bg-secondary">${typeDisplayName}</span></td>
                        <td>${device.groupId || '-'}</td>
                        <td>${device.ipAddress}:${device.port}</td>
                        <td>
                            <span class="badge bg-${getStatusColor(device.status)}">
                                <i class="${statusIcon}"></i> ${getStatusDisplayName(device.status)}
                            </span>
                        </td>
                        <td onclick="event.stopPropagation();">
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-success" onclick="controlDevice('${device.id}', 'turnOn')"
                                        ${device.status !== 'ONLINE' ? 'disabled' : ''}>
                                    <i class="bi bi-power"></i>
                                </button>
                                <button type="button" class="btn btn-outline-danger" onclick="controlDevice('${device.id}', 'turnOff')"
                                        ${device.status !== 'ONLINE' ? 'disabled' : ''}>
                                    <i class="bi bi-stop"></i>
                                </button>
                                <button type="button" class="btn btn-outline-primary" onclick="controlDevice('${device.id}', 'toggle')"
                                        ${device.status !== 'ONLINE' ? 'disabled' : ''}>
                                    <i class="bi bi-arrow-repeat"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;
            container.innerHTML = html;
        }

        // 更新设备数量
        function updateDeviceCount() {
            document.getElementById('deviceCount').textContent = filteredDevices.length;
        }

        // 切换视图
        function toggleView() {
            currentView = currentView === 'card' ? 'table' : 'card';
            const icon = document.getElementById('viewToggleIcon');
            const text = document.getElementById('viewToggleText');
            
            if (currentView === 'card') {
                icon.className = 'bi bi-grid-3x3-gap';
                text.textContent = '卡片视图';
            } else {
                icon.className = 'bi bi-table';
                text.textContent = '表格视图';
            }
            
            updateDeviceDisplay();
        }

        // 显示添加设备模态框
        function showAddDeviceModal() {
            new bootstrap.Modal(document.getElementById('addDeviceModal')).show();
        }

        // 添加设备
        function addDevice() {
            const deviceName = document.getElementById('deviceName').value;
            const deviceType = document.getElementById('deviceType').value;
            const deviceGroupId = document.getElementById('deviceGroupId').value;
            const deviceIP = document.getElementById('deviceIP').value;
            const devicePort = document.getElementById('devicePort').value;
            
            console.log('添加设备数据:', {
                name: deviceName,
                type: deviceType,
                groupId: deviceGroupId,
                ip: deviceIP,
                port: devicePort
            });
            
            const deviceConfig = {
                name: deviceName,
                type: deviceType,
                groupId: deviceGroupId || undefined,
                ipAddress: deviceIP || undefined,
                port: parseInt(devicePort) || undefined
            };

            if (!deviceConfig.name || !deviceConfig.type) {
                showToast('请填写设备名称和类型', 'warning');
                return;
            }

            console.log('发送设备配置:', deviceConfig);
            socket.emit('device:add', deviceConfig);
        }

        // 显示设备详情
        function showDeviceDetail(deviceId) {
            const device = allDevices.find(d => d.id === deviceId);
            if (!device) return;

            currentDevice = device;
            
            const content = document.getElementById('deviceDetailContent');
            content.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>基本信息</h6>
                        <table class="table table-sm">
                            <tr><td>设备名称</td><td>${device.name}</td></tr>
                            <tr><td>设备类型</td><td>${getTypeDisplayName(device.type)}</td></tr>
                            <tr><td>设备状态</td><td><span class="badge bg-${getStatusColor(device.status)}">${getStatusDisplayName(device.status)}</span></td></tr>
                            <tr><td>IP地址</td><td>${device.ipAddress}</td></tr>
                            <tr><td>端口</td><td>${device.port}</td></tr>
                            <tr><td>MAC地址</td><td>${device.macAddress}</td></tr>
                            <tr><td>分组ID</td><td>${device.groupId || '无分组'}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>设备属性</h6>
                        <table class="table table-sm">
                            ${device.data && typeof device.data === 'object' ? 
                                Object.entries(device.data).map(([key, value]) => 
                                    `<tr><td>${getPropertyDisplayName(key)}</td><td>${formatPropertyValue(key, value)}</td></tr>`
                                ).join('') : 
                                '<tr><td colspan="2" class="text-muted">暂无属性数据</td></tr>'
                            }
                        </table>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>元数据</h6>
                        <table class="table table-sm">
                            ${device.metadata ? `
                                <tr><td>制造商</td><td>${device.metadata.manufacturer || 'SSLAB教育科技'}</td></tr>
                                <tr><td>型号</td><td>${device.model || '未知'}</td></tr>
                                <tr><td>固件版本</td><td>${device.metadata.version || '1.0.0'}</td></tr>
                                <tr><td>创建时间</td><td>${formatDateTime(device.metadata.created)}</td></tr>
                                <tr><td>最后更新</td><td>${formatDateTime(device.metadata.lastUpdate)}</td></tr>
                                <tr><td>最后在线</td><td>${formatDateTime(device.metadata.lastSeen)}</td></tr>
                                <tr><td>运行时间</td><td>${formatUptime(device.metadata.uptime)}</td></tr>
                            ` : '<tr><td colspan="2" class="text-muted">暂无元数据</td></tr>'}
                        </table>
                    </div>
                </div>
            `;

            new bootstrap.Modal(document.getElementById('deviceDetailModal')).show();
        }

        // 控制设备
        function controlDevice(deviceId, command) {
            socket.emit('device:control', {
                id: deviceId,
                command: command
            });
        }

        // 刷新设备列表
        function refreshDevices() {
            socket.emit('devices:get');
            socket.emit('groups:get');
            showToast('正在刷新设备列表...', 'info');
        }

        // 一键添加测试设备
        async function addTestDevices() {
            const confirm = window.confirm('确定要添加测试设备吗？这将创建4种不同类型的ESP8266设备，每种类型2个设备。');
            if (!confirm) return;

            const deviceTypes = ['ENVIRONMENT_MONITOR', 'STUDENT_POWER_TERMINAL', 'ENVIRONMENT_CONTROLLER', 'CURTAIN_CONTROLLER', 'INTERACTIVE_STUDENT_TERMINAL', 'INTERACTIVE_DISPLAY', 'INTERACTIVE_CONTROLLER'];
            const deviceNames = {
                ENVIRONMENT_MONITOR: '环境检测装置',
                STUDENT_POWER_TERMINAL: '学生电源终端',
                ENVIRONMENT_CONTROLLER: '环境控制装置',
                CURTAIN_CONTROLLER: '窗帘控制装置',
                INTERACTIVE_STUDENT_TERMINAL: '互动教学学生终端',
                INTERACTIVE_DISPLAY: '互动教学显示设备',
                INTERACTIVE_CONTROLLER: '互动教学控制器'
            };

            try {
                showToast('正在创建测试设备...', 'info');
                let successCount = 0;
                let totalDevices = deviceTypes.length * 2; // 每种类型2个设备

                for (const type of deviceTypes) {
                    for (let i = 1; i <= 2; i++) {
                        const deviceData = {
                            name: `${deviceNames[type]}-${i}`,
                            type: type
                        };

                        const response = await fetch('/api/devices', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(deviceData)
                        });

                        if (response.ok) {
                            successCount++;
                        } else {
                            console.error(`创建设备失败: ${deviceData.name}`);
                        }
                    }
                }

                showToast(`测试设备创建完成！成功创建 ${successCount}/${totalDevices} 个设备`, 'success');
                
                // 刷新设备列表
                setTimeout(() => {
                    refreshDevices();
                }, 1000);

            } catch (error) {
                console.error('创建测试设备失败:', error);
                showToast('创建测试设备失败: ' + error.message, 'danger');
            }
        }

        // 清除过滤器
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('typeFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('groupFilter').value = '';
            applyFilters();
        }

        // 选择管理
        function toggleSelection(deviceId) {
            if (selectedDevices.has(deviceId)) {
                selectedDevices.delete(deviceId);
            } else {
                selectedDevices.add(deviceId);
            }
            updateBulkActionsToolbar();
        }

        function toggleAllSelection(checked) {
            if (checked) {
                filteredDevices.forEach(device => selectedDevices.add(device.id));
            } else {
                selectedDevices.clear();
            }
            updateDeviceDisplay();
            updateBulkActionsToolbar();
        }

        function clearSelection() {
            selectedDevices.clear();
            updateDeviceDisplay();
            updateBulkActionsToolbar();
        }

        function updateBulkActionsToolbar() {
            const toolbar = document.getElementById('bulkActionsToolbar');
            const count = selectedDevices.size;
            
            if (count > 0) {
                toolbar.style.display = 'block';
                document.getElementById('selectedCount').textContent = count;
            } else {
                toolbar.style.display = 'none';
            }
        }

        // 批量控制
        function bulkControl(command) {
            if (selectedDevices.size === 0) return;
            
            socket.emit('devices:control:batch', {
                deviceIds: Array.from(selectedDevices),
                command: command
            });
        }

        // 删除设备
        function deleteDevice() {
            if (!currentDevice) return;
            
            if (confirm(`确定要删除设备 "${currentDevice.name}" 吗？`)) {
                socket.emit('device:remove', { id: currentDevice.id });
                bootstrap.Modal.getInstance(document.getElementById('deviceDetailModal')).hide();
            }
        }

        // 编辑设备（简化版）
        function editDevice() {
            if (!currentDevice) return;
            
            const newName = prompt('请输入新的设备名称:', currentDevice.name);
            if (newName && newName !== currentDevice.name) {
                socket.emit('device:update', {
                    id: currentDevice.id,
                    config: { name: newName }
                });
            }
        }

        // 更新单个设备卡片
        function updateDeviceCard(device) {
            // 在当前视图中更新设备显示
            applyFilters();
        }

        // 工具函数
        function getTypeDisplayName(type) {
            const names = {
                'ENVIRONMENT_MONITOR': '环境检测装置',
                'STUDENT_POWER_TERMINAL': '学生电源终端',
                'ENVIRONMENT_CONTROLLER': '环境控制装置',
                'CURTAIN_CONTROLLER': '窗帘控制装置',
                'LIGHTING_CONTROLLER': '灯光控制装置',
                'LIFT_CONTROLLER': '升降控制装置',
                'INTERACTIVE_STUDENT_TERMINAL': '互动教学学生终端',
                'INTERACTIVE_DISPLAY': '互动教学显示设备',
                'INTERACTIVE_CONTROLLER': '互动教学控制器'
            };
            return names[type] || type;
        }

        function getStatusDisplayName(status) {
            const names = {
                'ONLINE': '在线',
                'OFFLINE': '离线',
                'CONNECTING': '连接中',
                'ERROR': '错误'
            };
            return names[status] || status;
        }

        function getStatusColor(status) {
            const colors = {
                'ONLINE': 'success',
                'OFFLINE': 'danger',
                'CONNECTING': 'warning',
                'ERROR': 'danger'
            };
            return colors[status] || 'secondary';
        }

        function getStatusIcon(status) {
            const icons = {
                'ONLINE': 'bi-check-circle',
                'OFFLINE': 'bi-x-circle',
                'CONNECTING': 'bi-clock',
                'ERROR': 'bi-exclamation-triangle'
            };
            return icons[status] || 'bi-question-circle';
        }

        function getPropertyDisplayName(property) {
            const names = {
                // 基本设备属性
                'model': '设备型号',
                'macAddress': 'MAC地址',
                'ipAddress': 'IP地址',
                'firmware': '固件版本',
                'uptime': '运行时间',
                'rssi': '信号强度',
                'freeHeap': '可用内存',
                'temperature': '芯片温度',
                'lastUpdate': '最后更新',
                'network': '网络配置',
                
                // 窗帘控制装置
                'curtain': '窗帘状态',
                'position': '窗帘位置',
                'moving': '运动状态',
                'direction': '运动方向',
                'speed': '运动速度',
                'auto': '自动模式',
                'motor': '电机状态',
                'steps': '步进数',
                'maxSteps': '最大步进数',
                'torque': '扭矩',
                'schedule': '定时设置',
                'enabled': '启用状态',
                'openTime': '开启时间',
                'closeTime': '关闭时间',
                'lightSensor': '光传感器',
                
                // 环境检测装置
                'sensors': '传感器数据',
                'humidity': '湿度',
                'pressure': '气压',
                'co2': 'CO2浓度',
                'voc': 'VOC浓度',
                'pm25': 'PM2.5',
                'pm10': 'PM10',
                'light': '光照度',
                'noise': '噪声',
                'display': '显示屏',
                'brightness': '亮度',
                'mode': '模式',
                'rotation': '旋转角度',
                'alerts': '报警设置',
                'temperatureHigh': '高温报警',
                'humidityHigh': '高湿报警',
                'co2High': 'CO2超标报警',
                'pm25High': 'PM2.5超标报警',
                
                // 学生电源终端
                'power': '电源状态',
                'voltage': '电压',
                'current': '电流',
                'maxVoltage': '最大电压',
                'maxCurrent': '最大电流',
                'emergency': '紧急状态',
                'locked': '锁定状态',
                'safety': '安全保护',
                'overVoltage': '过压保护',
                'overCurrent': '过流保护',
                'shortCircuit': '短路保护',
                'emergencyStop': '紧急停止',
                'student': '学生信息',
                'id': '学生ID',
                'name': '学生姓名',
                'group': '学生分组',
                'experiments': '实验记录',
                'history': '历史记录',
                
                // 环境控制装置
                'ventilation': '通风系统',
                'water': '供水系统',
                'supply': '供水状态',
                'drain': '排水状态',
                'flow': '流量',
                'air': '空气净化',
                'purifier': '净化器',
                'filter': '过滤器寿命',
                'ionizer': '离子发生器',
                
                // 灯光控制装置
                'lighting': '照明系统',
                'colorTemperature': '色温',
                'scene': '场景模式',
                'zones': '灯光分区',
                'energy': '能耗统计',
                'daily': '日用电量',
                'efficiency': '能效比',
                
                // 升降控制装置
                'lift': '升降平台',
                'load': '当前负载',
                'type': '电机类型',
                'precision': '精度信息',
                'accuracy': '准确度',
                'repeatability': '重复精度',
                'upperLimit': '上限位',
                'lowerLimit': '下限位',
                'overload': '过载保护',
                
                // 其他通用属性
                'port': '端口',
                'gateway': '网关',
                'subnet': '子网掩码',
                'dns': 'DNS服务器',
                'value': '数值',
                'unit': '单位',
                'calibration': '校准值',
                'detected': '检测状态',
                'lastDetection': '最后检测',
                'sensitivity': '灵敏度',
                'state': '状态',
                'red': '红色',
                'green': '绿色',
                'blue': '蓝色',
                'fadeTime': '渐变时间',
                'strobeFrequency': '频闪频率',
                
                // 互动教学设备专用属性
                'statistics': '统计数据',
                'currentQuestionId': '当前题目ID',
                'questionContent': '题目内容',
                'options': '选项',
                'timeRemaining': '剩余时间',
                'isActive': '活跃状态',
                'totalStudents': '学生总数',
                'answered': '已答题数',
                'correct': '正确答案数',
                'incorrect': '错误答案数',
                'timeout': '超时数量',
                'session': '会话信息',
                'startTime': '开始时间',
                'timeLimit': '时间限制',
                'autoNext': '自动下一题',
                'seatId': '座位编号',
                'studentName': '学生姓名',
                'status': '状态',
                'lastAnswer': '最后答案',
                'answerTime': '答题时间',
                'displayMode': '显示模式',
                'isFullscreen': '全屏状态'
            };
            return names[property] || property;
        }

        function formatPropertyValue(property, value) {
            if (value === null || value === undefined) {
                return '未知';
            }
            
            // 处理对象类型 - 解决 [object Object] 问题
            if (typeof value === 'object' && !Array.isArray(value)) {
                // 对于复杂对象，展示为可折叠的属性列表
                const entries = Object.entries(value);
                if (entries.length === 0) {
                    return '<em class="text-muted">空对象</em>';
                }
                
                let html = '<div class="object-details">';
                entries.forEach(([key, val]) => {
                    const displayName = getPropertyDisplayName(key);
                    const displayValue = formatSimpleValue(key, val);
                    html += `<div><strong>${displayName}:</strong> ${displayValue}</div>`;
                });
                html += '</div>';
                return html;
            }
            
            // 处理数组类型
            if (Array.isArray(value)) {
                if (value.length === 0) {
                    return '<em class="text-muted">空数组</em>';
                }
                return `<em class="text-muted">数组 (${value.length} 项)</em>`;
            }
            
            return formatSimpleValue(property, value);
        }
        
        function formatSimpleValue(property, value) {
            if (value === null || value === undefined) {
                return '未知';
            }
            
            if (typeof value === 'boolean') {
                return value ? '<span class="text-success">开启</span>' : '<span class="text-danger">关闭</span>';
            }
            
            if (typeof value === 'string' && value.includes('T') && value.includes('Z')) {
                // 日期时间格式
                try {
                    return new Date(value).toLocaleString('zh-CN');
                } catch (e) {
                    return value;
                }
            }
            
            // 特殊格式处理
            if (property === 'rssi') {
                return `${value} dBm`;
            }
            
            if (property === 'freeHeap') {
                return `${(value / 1024).toFixed(1)} KB`;
            }
            
            if (property === 'uptime') {
                if (typeof value === 'number') {
                    const hours = Math.floor(value / 3600000);
                    const minutes = Math.floor((value % 3600000) / 60000);
                    const seconds = Math.floor((value % 60000) / 1000);
                    return `${hours}时${minutes}分${seconds}秒`;
                }
                return value;
            }
            
            const units = {
                'temperature': '°C',
                'humidity': '%',
                'pressure': ' hPa',
                'co2': ' ppm',
                'voc': ' ppb',
                'pm25': ' μg/m³',
                'pm10': ' μg/m³',
                'light': ' lux',
                'noise': ' dB',
                'voltage': 'V',
                'current': 'A',
                'power': 'W',
                'maxVoltage': 'V',
                'maxCurrent': 'A',
                'brightness': '%',
                'colorTemperature': 'K',
                'position': '%',
                'speed': ' mm/s',
                'load': ' kg',
                'steps': ' 步',
                'maxSteps': ' 步',
                'torque': '%',
                'flow': ' L/min',
                'filter': '%',
                'daily': ' kWh',
                'efficiency': '%',
                'accuracy': ' mm',
                'repeatability': ' mm'
            };
            
            const unit = units[property] || '';
            
            if (typeof value === 'number') {
                // 根据属性类型决定小数位数
                let decimals = 1;
                if (property.includes('current') || property.includes('voltage')) {
                    decimals = 2;
                } else if (property.includes('temperature') || property.includes('humidity')) {
                    decimals = 1;
                } else if (property === 'steps' || property === 'maxSteps') {
                    decimals = 0;
                }
                
                return value.toFixed(decimals) + unit;
            }
            
            if (typeof value === 'string') {
                // 特殊字符串值的中文化
                const translations = {
                    'ON': '开启',
                    'OFF': '关闭',
                    'ONLINE': '在线',
                    'OFFLINE': '离线',
                    'auto': '自动',
                    'manual': '手动',
                    'stop': '停止',
                    'up': '上升',
                    'down': '下降',
                    'open': '打开',
                    'close': '关闭',
                    'in': '进风',
                    'out': '出风',
                    'both': '双向',
                    'stepper': '步进电机',
                    'normal': '正常',
                    'reading': '阅读',
                    'presentation': '演示',
                    'rest': '休息'
                };
                
                return translations[value] || value;
            }
            
            return value + unit;
        }

        function formatDateTime(dateString) {
            if (!dateString) return '未知';
            try {
                return new Date(dateString).toLocaleString();
            } catch (e) {
                return '未知';
            }
        }

        function formatUptime(uptime) {
            if (!uptime || typeof uptime !== 'number') return '未知';
            const hours = Math.floor(uptime / 3600);
            const minutes = Math.floor((uptime % 3600) / 60);
            return `${hours}h ${minutes}m`;
        }

        function showToast(message, type = 'info') {
            // 简单的toast实现
            let alertClass = 'alert-info';
            if (type === 'success') alertClass = 'alert-success';
            else if (type === 'danger') alertClass = 'alert-danger';
            else if (type === 'warning') alertClass = 'alert-warning';
            
            const toast = document.createElement('div');
            toast.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
            toast.style.top = '20px';
            toast.style.right = '20px';
            toast.style.zIndex = '9999';
            toast.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 5000);
        }

        // 事件监听器
        document.getElementById('searchInput').addEventListener('input', applyFilters);
        document.getElementById('typeFilter').addEventListener('change', applyFilters);
        document.getElementById('statusFilter').addEventListener('change', applyFilters);
        document.getElementById('groupFilter').addEventListener('change', applyFilters);

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            refreshDevices();
        });
    </script>
    
    <!-- 导航栏组件加载器 -->
    <script src="js/navbar.js"></script>
</body>
</html>
