<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»ç»Ÿç®¡ç† - SSLABè®¾å¤‡æ¨¡æ‹Ÿå™¨</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        .system-logs-container {
            height: 400px;
            overflow-y: auto;
            background-color: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.875rem;
            padding: 0;
            border-radius: 0.375rem;
            width: 100%;
            box-sizing: border-box;
        }
        .log-error {
            color: #f85149;
        }
        .log-warn {
            color: #f0ad4e;
        }
        .log-info {
            color: #79b8ff;
        }
        .log-success {
            color: #56d364;
        }
    </style>
</head>
<body>
    <!-- ç»Ÿä¸€å¯¼èˆªæ å®¹å™¨ -->
    <div id="navbar-container"></div>

    <div class="container">
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">âš™ï¸ ç³»ç»Ÿè®¾ç½®</h5>
                        </div>
                        <div class="card-body">
                            <h6>æœåŠ¡å™¨é…ç½®</h6>
                            <div class="mb-3">
                                <label class="form-label">æœåŠ¡å™¨ç«¯å£</label>
                                <input type="number" class="form-control" id="serverPort" value="8080" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">UDPå‘ç°ç«¯å£</label>
                                <input type="number" class="form-control" id="udpPort" value="12345" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">è®¾å¤‡æ•°æ®æ›´æ–°é—´éš”(ç§’)</label>
                                <input type="number" class="form-control" id="updateInterval" value="5" min="1" max="60">
                            </div>
                            <button class="btn btn-primary" onclick="updateSettings()">ä¿å­˜è®¾ç½®</button>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">ğŸ“Š ç³»ç»ŸçŠ¶æ€</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-6">
                                    <h6>è¿è¡Œæ—¶é—´</h6>
                                    <p id="uptime" class="text-muted">è®¡ç®—ä¸­...</p>
                                </div>
                                <div class="col-6">
                                    <h6>å†…å­˜ä½¿ç”¨</h6>
                                    <p id="memoryUsage" class="text-muted">è®¡ç®—ä¸­...</p>
                                </div>
                                <div class="col-6">
                                    <h6>è¿æ¥å®¢æˆ·ç«¯</h6>
                                    <p id="connectedClients" class="text-muted">0</p>
                                </div>
                                <div class="col-6">
                                    <h6>APIè°ƒç”¨æ¬¡æ•°</h6>
                                    <p id="apiCalls" class="text-muted">0</p>
                                </div>
                            </div>
                            <button class="btn btn-outline-primary" onclick="refreshSystemInfo()">åˆ·æ–°ä¿¡æ¯</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <!-- ç³»ç»Ÿæ—¥å¿—åŒºåŸŸ -->
                <div class="col-md-8">
                    <div class="card h-100">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">ğŸ“‹ ç³»ç»Ÿæ—¥å¿—</h6>
                                <div class="d-flex align-items-center">
                                    <select class="form-select form-select-sm me-2" id="logLevel" style="width: 100px;">
                                        <option value="all">å…¨éƒ¨</option>
                                        <option value="error">é”™è¯¯</option>
                                        <option value="warning">è­¦å‘Š</option>
                                        <option value="info">ä¿¡æ¯</option>
                                        <option value="debug">è°ƒè¯•</option>
                                    </select>
                                    <div class="form-check form-switch d-inline-block me-3">
                                        <input class="form-check-input" type="checkbox" id="autoScroll" checked>
                                        <label class="form-check-label" for="autoScroll">è‡ªåŠ¨æ»šåŠ¨</label>
                                    </div>
                                    <button class="btn btn-outline-danger btn-sm" onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="systemLogs" class="system-logs-container">
                                <!-- ç³»ç»Ÿæ—¥å¿—å†…å®¹ -->
                                <div class="text-muted py-3">
                                    ç³»ç»Ÿæ—¥å¿—å°†åœ¨è¿™é‡Œæ˜¾ç¤º...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å³ä¾§æ“ä½œé¢æ¿ -->
                <div class="col-md-4">
                    <div class="row">
                        <!-- æ•°æ®ç®¡ç† -->
                        <div class="col-12 mb-3">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">ğŸ“ æ•°æ®ç®¡ç†</h6>
                                </div>
                                <div class="card-body">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-success" onclick="createTestDevices()">
                                            <i class="bi bi-plus-circle"></i> ä¸€é”®åˆ›å»ºæµ‹è¯•è®¾å¤‡
                                        </button>
                                        <button class="btn btn-info" onclick="exportSystemData()">
                                            <i class="bi bi-download"></i> å¯¼å‡ºç³»ç»Ÿæ•°æ®
                                        </button>
                                        <input type="file" class="form-control" id="importFile" accept=".json">
                                        <button class="btn btn-primary" onclick="importSystemData()">
                                            <i class="bi bi-upload"></i> å¯¼å…¥ç³»ç»Ÿæ•°æ®
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ç³»ç»Ÿæ§åˆ¶ -->
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">ğŸ› ï¸ ç³»ç»Ÿæ§åˆ¶</h6>
                                </div>
                                <div class="card-body">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-info" onclick="showApiDocs()">
                                            <i class="bi bi-book"></i> æŸ¥çœ‹APIæ–‡æ¡£
                                        </button>
                                        <button class="btn btn-warning" onclick="restartServer()">
                                            <i class="bi bi-arrow-clockwise"></i> é‡å¯æœåŠ¡å™¨
                                        </button>
                                        <button class="btn btn-secondary" onclick="enableMaintenanceMode()">
                                            <i class="bi bi-tools"></i> ç»´æŠ¤æ¨¡å¼
                                        </button>
                                        <button class="btn btn-danger" onclick="shutdownServer()">
                                            <i class="bi bi-power"></i> å…³é—­æœåŠ¡å™¨
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let systemLogs = [];
        let startTime = Date.now();

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            refreshSystemInfo();
            refreshLogs();
            setupSocketListeners();
            
            // å®šæœŸæ›´æ–°ç³»ç»Ÿä¿¡æ¯
            setInterval(refreshSystemInfo, 10000);
        });

        // Socketäº‹ä»¶ç›‘å¬
        function setupSocketListeners() {
            socket.on('systemLog', function(log) {
                systemLogs.unshift(log);
                if (systemLogs.length > 1000) {
                    systemLogs.pop();
                }
                updateLogsDisplay();
            });

            socket.on('systemStats', function(stats) {
                updateSystemStats(stats);
            });
        }

        // æ›´æ–°ç³»ç»Ÿè®¾ç½®
        function updateSettings() {
            const settings = {
                updateInterval: parseInt(document.getElementById('updateInterval').value)
            };

            // è¿™é‡Œå¯ä»¥å‘é€è®¾ç½®åˆ°æœåŠ¡å™¨
            // socket.emit('updateSettings', settings);
            
            alert('è®¾ç½®å·²ä¿å­˜ï¼ˆæ¼”ç¤ºåŠŸèƒ½ï¼‰');
        }

        // åˆ·æ–°ç³»ç»Ÿä¿¡æ¯
        function refreshSystemInfo() {
            fetch('/api/system/health')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const health = data.data;
                        
                        // æ›´æ–°è¿è¡Œæ—¶é—´
                        document.getElementById('uptime').textContent = health.server.uptimeFormatted;
                        
                        // æ›´æ–°å†…å­˜ä½¿ç”¨ (æ˜¾ç¤ºè¿›ç¨‹å†…å­˜)
                        const processMemory = health.memory.process;
                        document.getElementById('memoryUsage').textContent = 
                            `${processMemory.rss}MB / ${health.memory.system.total}MB (è¿›ç¨‹: ${processMemory.heapUsed}MBå †å†…å­˜)`;
                        
                        // æ›´æ–°è¿æ¥å®¢æˆ·ç«¯æ•°
                        document.getElementById('connectedClients').textContent = health.application.connectedClients;
                        
                        // æ›´æ–°APIè°ƒç”¨æ¬¡æ•°
                        document.getElementById('apiCalls').textContent = health.application.apiCallsToday;
                        
                        addLog('info', `ç³»ç»Ÿä¿¡æ¯å·²æ›´æ–° - è¿è¡Œæ—¶é—´: ${health.server.uptimeFormatted}, å†…å­˜: ${processMemory.rss}MB`);
                    }
                })
                .catch(error => {
                    console.error('è·å–ç³»ç»Ÿä¿¡æ¯å¤±è´¥:', error);
                    addLog('error', 'è·å–ç³»ç»Ÿä¿¡æ¯å¤±è´¥: ' + error.message);
                });
        }

        // å¯¼å‡ºç³»ç»Ÿæ•°æ®
        function exportSystemData() {
            Promise.all([
                fetch('/api/devices').then(r => r.json()),
                fetch('/api/groups').then(r => r.json())
            ]).then(([devicesResult, groupsResult]) => {
                const data = {
                    exportTime: new Date().toISOString(),
                    devices: devicesResult.success ? devicesResult.data : devicesResult,
                    groups: groupsResult.success ? groupsResult.data : groupsResult,
                    logs: systemLogs.slice(0, 100) // æœ€è¿‘100æ¡æ—¥å¿—
                };

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `sslab_system_data_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);

                addLog('info', 'ç³»ç»Ÿæ•°æ®å·²å¯¼å‡º');
            }).catch(error => {
                addLog('error', 'å¯¼å‡ºç³»ç»Ÿæ•°æ®å¤±è´¥: ' + error.message);
                alert('å¯¼å‡ºå¤±è´¥');
            });
        }

        // å¯¼å…¥ç³»ç»Ÿæ•°æ®
        function importSystemData() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('è¯·é€‰æ‹©è¦å¯¼å…¥çš„æ–‡ä»¶');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (confirm('å¯¼å…¥æ•°æ®å°†è¦†ç›–ç°æœ‰æ•°æ®ï¼Œç¡®è®¤ç»§ç»­å—ï¼Ÿ')) {
                        // è¿™é‡Œåº”è¯¥è°ƒç”¨å¯¼å…¥API
                        addLog('info', 'ç³»ç»Ÿæ•°æ®å¯¼å…¥åŠŸèƒ½å¾…å®ç°');
                        alert('å¯¼å…¥åŠŸèƒ½å¾…å®ç°');
                    }
                } catch (error) {
                    addLog('error', 'å¯¼å…¥æ–‡ä»¶æ ¼å¼é”™è¯¯');
                    alert('æ–‡ä»¶æ ¼å¼é”™è¯¯');
                }
            };
            reader.readAsText(file);
        }

        // ä¸€é”®åˆ›å»ºæµ‹è¯•è®¾å¤‡
        async function createTestDevices() {
            if (!confirm('å°†åˆ›å»º100ä¸ªæµ‹è¯•è®¾å¤‡å’Œ4ä¸ªåˆ†ç»„ï¼Œè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ã€‚ç¡®è®¤ç»§ç»­å—ï¼Ÿ')) {
                return;
            }
            
            const button = document.querySelector('button[onclick="createTestDevices()"]');
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<i class="bi bi-hourglass-split"></i> æ­£åœ¨åˆ›å»º...';
            
            try {
                addLog('info', 'å¼€å§‹æ‰¹é‡åˆ›å»ºæµ‹è¯•è®¾å¤‡...');
                
                const response = await fetch('/api/system/create-test-devices', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        deviceCount: 100,
                        groupCount: 4
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addLog('success', result.message);
                    alert(`æµ‹è¯•è®¾å¤‡åˆ›å»ºæˆåŠŸï¼\nè®¾å¤‡æ•°é‡: ${result.data.devices}\nåˆ†ç»„æ•°é‡: ${result.data.groups}`);
                    
                    // å¯é€‰ï¼šåˆ·æ–°é¡µé¢æˆ–æ›´æ–°ç›¸å…³ä¿¡æ¯
                    refreshSystemInfo();
                } else {
                    addLog('error', 'åˆ›å»ºæµ‹è¯•è®¾å¤‡å¤±è´¥: ' + result.error);
                    alert('åˆ›å»ºå¤±è´¥: ' + result.error);
                }
                
            } catch (error) {
                addLog('error', 'åˆ›å»ºæµ‹è¯•è®¾å¤‡å‡ºé”™: ' + error.message);
                alert('æ“ä½œå¤±è´¥: ' + error.message);
            } finally {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        // åˆ·æ–°æ—¥å¿—
        function refreshLogs() {
            // ç”Ÿæˆä¸€äº›ç¤ºä¾‹æ—¥å¿—
            const levels = ['info', 'warning', 'error'];
            const messages = [
                'è®¾å¤‡çŠ¶æ€æ›´æ–°å®Œæˆ',
                'å®¢æˆ·ç«¯è¿æ¥',
                'è®¾å¤‡æ§åˆ¶æŒ‡ä»¤',
                'UDPå¹¿æ’­å‘é€',
                'WebSocketè¿æ¥å»ºç«‹',
                'ç³»ç»Ÿå¥åº·æ£€æŸ¥'
            ];
            
            for (let i = 0; i < 10; i++) {
                const level = levels[Math.floor(Math.random() * levels.length)];
                const message = messages[Math.floor(Math.random() * messages.length)];
                addLog(level, message);
            }
        }

        // æ·»åŠ æ—¥å¿—
        function addLog(level, message) {
            const log = {
                timestamp: new Date().toLocaleString(),
                level: level,
                message: message
            };
            
            systemLogs.unshift(log);
            if (systemLogs.length > 1000) {
                systemLogs.pop();
            }
            
            updateLogsDisplay();
        }

        // æ›´æ–°æ—¥å¿—æ˜¾ç¤º
        function updateLogsDisplay() {
            const selectedLevel = document.getElementById('logLevel').value;
            const filteredLogs = selectedLevel === 'all' 
                ? systemLogs 
                : systemLogs.filter(log => log.level === selectedLevel);
            
            const logsContainer = document.getElementById('systemLogs');
            logsContainer.innerHTML = '';
            
            if (filteredLogs.length === 0) {
                logsContainer.innerHTML = '<div class="text-muted text-start">æš‚æ— æ—¥å¿—è®°å½•</div>';
                return;
            }
            
            filteredLogs.slice(0, 50).forEach(log => {
                const logEntry = document.createElement('div');
                // ç›´æ¥è®¾ç½®æ ·å¼ï¼Œä¸ä½¿ç”¨ Bootstrap ç±»
                logEntry.style.cssText = `
                    margin: 0;
                    padding: 0.25rem 1rem;
                    width: 100%;
                    box-sizing: border-box;
                    display: block;
                    background-color: #1e1e1e;
                    border: none;
                `;
                
                const levelColor = {
                    info: '#0dcaf0',     // text-info color
                    warning: '#ffc107',  // text-warning color 
                    error: '#dc3545'     // text-danger color
                }[log.level] || '#f8f9fa'; // text-light color
                
                logEntry.innerHTML = `
                    <span style="color: #6c757d;">[${log.timestamp}]</span> 
                    <span style="color: ${levelColor};">[${log.level.toUpperCase()}]</span> 
                    <span style="color: #f8f9fa;">${log.message}</span>
                `;
                
                logsContainer.appendChild(logEntry);
            });
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLogs() {
            if (confirm('ç¡®è®¤è¦æ¸…ç©ºæ‰€æœ‰æ—¥å¿—å—ï¼Ÿ')) {
                systemLogs = [];
                updateLogsDisplay();
                addLog('info', 'æ—¥å¿—å·²æ¸…ç©º');
            }
        }

        // ä¸‹è½½æ—¥å¿—
        function downloadLogs() {
            const selectedLevel = document.getElementById('logLevel').value;
            const filteredLogs = selectedLevel === 'all' 
                ? systemLogs 
                : systemLogs.filter(log => log.level === selectedLevel);
            
            const logText = filteredLogs.map(log => 
                `[${log.timestamp}] [${log.level.toUpperCase()}] ${log.message}`
            ).join('\n');
            
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sslab_logs_${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            addLog('info', 'æ—¥å¿—æ–‡ä»¶å·²ä¸‹è½½');
        }

        // æ˜¾ç¤ºæ·»åŠ è®¾å¤‡æ¨¡æ€æ¡†
        async function showAddDeviceModal() {
            try {
                // åŠ è½½è®¾å¤‡ç±»å‹
                const response = await fetch('/api/info/device-types');
                const result = await response.json();
                
                if (result.success) {
                    const select = document.getElementById('deviceType');
                    select.innerHTML = '<option value="">è¯·é€‰æ‹©è®¾å¤‡ç±»å‹</option>';
                    
                    result.data.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type.type;
                        option.textContent = `${type.name} (${type.model})`;
                        option.dataset.description = type.description;
                        select.appendChild(option);
                    });
                }
                
                // åŠ è½½åˆ†ç»„ä¿¡æ¯
                const groupResponse = await fetch('/api/groups');
                const groupResult = await groupResponse.json();
                
                if (groupResult.success) {
                    const groupSelect = document.getElementById('deviceGroup');
                    groupSelect.innerHTML = '<option value="">æ— åˆ†ç»„</option>';
                    
                    const groups = Array.isArray(groupResult.data) ? groupResult.data : Object.values(groupResult.data);
                    groups.forEach(group => {
                        const option = document.createElement('option');
                        option.value = group.groupId || group.id;
                        option.textContent = group.name;
                        groupSelect.appendChild(option);
                    });
                }
                
                // è®¾ç½®äº‹ä»¶ç›‘å¬
                document.getElementById('deviceType').addEventListener('change', updateDevicePreview);
                
                new bootstrap.Modal(document.getElementById('addDeviceModal')).show();
            } catch (error) {
                addLog('error', 'åŠ è½½è®¾å¤‡ç±»å‹å¤±è´¥: ' + error.message);
                alert('åŠ è½½è®¾å¤‡ç±»å‹å¤±è´¥');
            }
        }

        // æ›´æ–°è®¾å¤‡é¢„è§ˆä¿¡æ¯
        async function updateDevicePreview() {
            const select = document.getElementById('deviceType');
            const selectedType = select.value;
            const preview = document.getElementById('devicePreview');
            const typeInfo = document.getElementById('deviceTypeInfo');
            
            if (!selectedType) {
                preview.innerHTML = '<small class="text-muted">è¯·é€‰æ‹©è®¾å¤‡ç±»å‹æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</small>';
                typeInfo.textContent = '';
                return;
            }
            
            const selectedOption = select.options[select.selectedIndex];
            typeInfo.textContent = selectedOption.dataset.description;
            
            try {
                const response = await fetch(`/api/info/device-capabilities/${selectedType}`);
                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    preview.innerHTML = `
                        <div class="row">
                            <div class="col-md-6">
                                <strong>è®¾å¤‡å‹å·ï¼š</strong> ${data.model}<br>
                                <strong>è®¾å¤‡ç±»å‹ï¼š</strong> ${data.name}<br>
                                <strong>æ”¯æŒåŠŸèƒ½ï¼š</strong><br>
                                <ul class="mb-0 small">
                                    ${data.capabilities.map(cap => `<li>${cap}</li>`).join('')}
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <strong>æ”¯æŒå‘½ä»¤ï¼š</strong><br>
                                <ul class="mb-0 small">
                                    ${data.commands.map(cmd => `<li><code>${cmd.command}</code> - ${cmd.description}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    `;
                } else {
                    preview.innerHTML = '<small class="text-danger">åŠ è½½è®¾å¤‡ä¿¡æ¯å¤±è´¥</small>';
                }
            } catch (error) {
                preview.innerHTML = '<small class="text-danger">åŠ è½½è®¾å¤‡ä¿¡æ¯å‡ºé”™</small>';
            }
        }

        // åˆ›å»ºè®¾å¤‡
        async function createDevice() {
            const form = document.getElementById('addDeviceForm');
            const formData = new FormData(form);
            
            const deviceName = document.getElementById('deviceName').value.trim();
            const deviceType = document.getElementById('deviceType').value;
            const deviceGroup = document.getElementById('deviceGroup').value;
            const autoStart = document.getElementById('autoStart').checked;
            
            if (!deviceName) {
                alert('è¯·è¾“å…¥è®¾å¤‡åç§°');
                return;
            }
            
            if (!deviceType) {
                alert('è¯·é€‰æ‹©è®¾å¤‡ç±»å‹');
                return;
            }
            
            try {
                const deviceData = {
                    name: deviceName,
                    type: deviceType,
                    groupId: deviceGroup || null
                };
                
                const response = await fetch('/api/devices', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(deviceData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addLog('info', `æˆåŠŸåˆ›å»ºè®¾å¤‡: ${deviceName} (${deviceType})`);
                    
                    // å¦‚æœé€‰æ‹©è‡ªåŠ¨å¯åŠ¨ï¼Œåˆ™å¯åŠ¨è®¾å¤‡
                    if (autoStart && !result.data.enabled) {
                        try {
                            await fetch(`/api/devices/${result.data.id}/control`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ command: 'turnOn' })
                            });
                            addLog('info', `è®¾å¤‡ ${deviceName} å·²è‡ªåŠ¨å¯åŠ¨`);
                        } catch (startError) {
                            addLog('warning', `è®¾å¤‡åˆ›å»ºæˆåŠŸï¼Œä½†å¯åŠ¨å¤±è´¥: ${startError.message}`);
                        }
                    }
                    
                    // å…³é—­æ¨¡æ€æ¡†
                    bootstrap.Modal.getInstance(document.getElementById('addDeviceModal')).hide();
                    
                    // æ¸…ç©ºè¡¨å•
                    form.reset();
                    document.getElementById('devicePreview').innerHTML = '<small class="text-muted">è¯·é€‰æ‹©è®¾å¤‡ç±»å‹æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</small>';
                    document.getElementById('deviceTypeInfo').textContent = '';
                    
                    alert(`è®¾å¤‡ "${deviceName}" åˆ›å»ºæˆåŠŸï¼`);
                } else {
                    addLog('error', `åˆ›å»ºè®¾å¤‡å¤±è´¥: ${result.error}`);
                    alert(`åˆ›å»ºè®¾å¤‡å¤±è´¥: ${result.error}`);
                }
            } catch (error) {
                addLog('error', `åˆ›å»ºè®¾å¤‡å‡ºé”™: ${error.message}`);
                alert(`åˆ›å»ºè®¾å¤‡å‡ºé”™: ${error.message}`);
            }
        }

        // æ˜¾ç¤ºAPIæ–‡æ¡£
        async function showApiDocs() {
            try {
                const modal = new bootstrap.Modal(document.getElementById('apiDocsModal'));
                modal.show();
                
                const response = await fetch('/api/info/api-docs');
                const docs = await response.json();
                
                const content = document.getElementById('apiDocsContent');
                content.innerHTML = `
                    <div class="row">
                        <div class="col-12">
                            <h4>${docs.title}</h4>
                            <p class="text-muted">${docs.description}</p>
                            <p><strong>åŸºç¡€URL:</strong> <code>${docs.baseUrl}</code></p>
                            <hr>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <h5>è®¾å¤‡ç®¡ç†æ¥å£</h5>
                            ${Object.entries(docs.endpoints.devices).map(([endpoint, info]) => `
                                <div class="card mb-2">
                                    <div class="card-body p-2">
                                        <h6 class="card-title mb-1"><code>${endpoint}</code></h6>
                                        <p class="card-text small mb-1">${info.description}</p>
                                        ${info.body ? `<small class="text-muted">è¯·æ±‚ä½“: ${JSON.stringify(info.body)}</small>` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="col-md-4">
                            <h5>åˆ†ç»„ç®¡ç†æ¥å£</h5>
                            ${Object.entries(docs.endpoints.groups).map(([endpoint, info]) => `
                                <div class="card mb-2">
                                    <div class="card-body p-2">
                                        <h6 class="card-title mb-1"><code>${endpoint}</code></h6>
                                        <p class="card-text small mb-1">${info.description}</p>
                                        ${info.body ? `<small class="text-muted">è¯·æ±‚ä½“: ${JSON.stringify(info.body)}</small>` : ''}
                                    </div>
                                </div>
                            `).join('')}
                            
                            <h5 class="mt-3">ä¿¡æ¯æŸ¥è¯¢æ¥å£</h5>
                            ${Object.entries(docs.endpoints.info).map(([endpoint, info]) => `
                                <div class="card mb-2">
                                    <div class="card-body p-2">
                                        <h6 class="card-title mb-1"><code>${endpoint}</code></h6>
                                        <p class="card-text small mb-1">${info.description}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="col-md-4">
                            <h5>ç³»ç»Ÿç®¡ç†æ¥å£</h5>
                            ${docs.endpoints.system ? Object.entries(docs.endpoints.system).map(([endpoint, info]) => `
                                <div class="card mb-2">
                                    <div class="card-body p-2">
                                        <h6 class="card-title mb-1"><code>${endpoint}</code></h6>
                                        <p class="card-text small mb-1">${info.description}</p>
                                        ${info.body ? `<small class="text-muted">è¯·æ±‚ä½“: ${JSON.stringify(info.body)}</small>` : ''}
                                    </div>
                                </div>
                            `).join('') : ''}
                            
                            <h5 class="mt-3">ç»Ÿè®¡ä¿¡æ¯æ¥å£</h5>
                            ${docs.endpoints.stats ? Object.entries(docs.endpoints.stats).map(([endpoint, info]) => `
                                <div class="card mb-2">
                                    <div class="card-body p-2">
                                        <h6 class="card-title mb-1"><code>${endpoint}</code></h6>
                                        <p class="card-text small mb-1">${info.description}</p>
                                    </div>
                                </div>
                            `).join('') : ''}
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <h5>è¯·æ±‚ç¤ºä¾‹</h5>
                            ${Object.entries(docs.examples).map(([name, example]) => `
                                <div class="card mb-2">
                                    <div class="card-header py-2">
                                        <h6 class="mb-0">${name}</h6>
                                    </div>
                                    <div class="card-body p-2">
                                        <pre class="mb-1"><code>${example.url}</code></pre>
                                        ${example.body ? `<pre class="mb-0"><code>${JSON.stringify(example.body, null, 2)}</code></pre>` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } catch (error) {
                document.getElementById('apiDocsContent').innerHTML = `
                    <div class="alert alert-danger">
                        <strong>åŠ è½½APIæ–‡æ¡£å¤±è´¥:</strong> ${error.message}
                    </div>
                `;
            }
        }

        // æœåŠ¡å™¨æ§åˆ¶åŠŸèƒ½ï¼ˆæ¼”ç¤ºç”¨ï¼‰
        function restartServer() {
            if (confirm('ç¡®è®¤è¦é‡å¯æœåŠ¡å™¨å—ï¼Ÿ')) {
                addLog('warning', 'æœåŠ¡å™¨é‡å¯åŠŸèƒ½å¾…å®ç°');
                alert('é‡å¯åŠŸèƒ½å¾…å®ç°');
            }
        }

        function enableMaintenanceMode() {
            addLog('info', 'ç»´æŠ¤æ¨¡å¼åŠŸèƒ½å¾…å®ç°');
            alert('ç»´æŠ¤æ¨¡å¼åŠŸèƒ½å¾…å®ç°');
        }

        function shutdownServer() {
            if (confirm('ç¡®è®¤è¦å…³é—­æœåŠ¡å™¨å—ï¼Ÿè¿™å°†æ–­å¼€æ‰€æœ‰è¿æ¥ã€‚')) {
                addLog('error', 'æœåŠ¡å™¨å…³é—­åŠŸèƒ½å¾…å®ç°');
                alert('å…³é—­åŠŸèƒ½å¾…å®ç°');
            }
        }

        // æ—¥å¿—çº§åˆ«è¿‡æ»¤
        document.getElementById('logLevel').addEventListener('change', updateLogsDisplay);
    </script>

    <style>
        .system-logs {
            height: 400px;
            overflow-y: auto;
            font-size: 0.875rem;
            line-height: 1.4;
        }

        .system-logs::-webkit-scrollbar {
            width: 8px;
        }

        .system-logs::-webkit-scrollbar-track {
            background: #343a40;
        }

        .system-logs::-webkit-scrollbar-thumb {
            background: #6c757d;
            border-radius: 4px;
        }

        .system-logs::-webkit-scrollbar-thumb:hover {
            background: #5a6268;
        }
    </style>

    <!-- æ·»åŠ è®¾å¤‡æ¨¡æ€æ¡† -->
    <div class="modal fade" id="addDeviceModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">æ·»åŠ æ–°è®¾å¤‡</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addDeviceForm">
                        <div class="mb-3">
                            <label for="deviceName" class="form-label">è®¾å¤‡åç§° *</label>
                            <input type="text" class="form-control" id="deviceName" required 
                                   placeholder="ä¾‹å¦‚ï¼šå®¢å…æ™ºèƒ½å¼€å…³">
                        </div>
                        <div class="mb-3">
                            <label for="deviceType" class="form-label">è®¾å¤‡ç±»å‹ *</label>
                            <select class="form-select" id="deviceType" required>
                                <option value="">è¯·é€‰æ‹©è®¾å¤‡ç±»å‹</option>
                            </select>
                            <div class="form-text">
                                <small id="deviceTypeInfo" class="text-muted"></small>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="deviceGroup" class="form-label">è®¾å¤‡åˆ†ç»„</label>
                            <select class="form-select" id="deviceGroup">
                                <option value="">æ— åˆ†ç»„</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="autoStart" checked>
                                <label class="form-check-label" for="autoStart">
                                    åˆ›å»ºåè‡ªåŠ¨å¯åŠ¨è®¾å¤‡
                                </label>
                            </div>
                        </div>
                        <div class="alert alert-info">
                            <strong>è®¾å¤‡ä¿¡æ¯é¢„è§ˆï¼š</strong>
                            <div id="devicePreview" class="mt-2">
                                <small class="text-muted">è¯·é€‰æ‹©è®¾å¤‡ç±»å‹æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</small>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="createDevice()">åˆ›å»ºè®¾å¤‡</button>
                </div>
            </div>
        </div>
    </div>

    <!-- APIæ–‡æ¡£æ¨¡æ€æ¡† -->
    <div class="modal fade" id="apiDocsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">APIæ¥å£æ–‡æ¡£</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="apiDocsContent">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">åŠ è½½ä¸­...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Socket.IO -->
    <script src="/socket.io/socket.io.js"></script>
    
    <!-- å¯¼èˆªæ ç»„ä»¶åŠ è½½å™¨ -->
    <script src="js/navbar.js"></script>
</body>
</html>
